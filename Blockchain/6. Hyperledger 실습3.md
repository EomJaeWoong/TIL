# Hyperledger

###### 하이퍼레저에 웹을 붙여보자

1. ubuntu의 VSCode를 키자



2. HLF/fabric-samples/basic-network의 connection.json을 복사해서 1jes/myweb/basic_articles에 붙여넣기 한다

   

3. MyWeb/basic_articles 밑에 connection.json을 다음과 같이 작성

   ```json
   {
       "name": "basic-network",
       "version": "1.0.0",
       "client": {
           "organization": "Org1",
           "connection": {
               "timeout": {
                   "peer": {
                       "endorser": "300"
                   },
                   "orderer": "300"
               }
           }
       },
       "channels": {
           "mychannel": {
               "orderers": [
                   "orderer.example.com"
               ],
               "peers": {
                   "peer0.org1.example.com": {}
               }
           }
       },
       "organizations": {
           "Org1": {
               "mspid": "Org1MSP",
               "peers": [
                   "peer0.org1.example.com"
               ],
               "certificateAuthorities": [
                   "ca.example.com"
               ]
           }
       },
       "orderers": {
           "orderer.example.com": {
               "url": "grpc://localhost:7050"
           }
       },
       "peers": {
           "peer0.org1.example.com": {
               "url": "grpc://localhost:7051"
           }
       },
       "certificateAuthorities": {
           "ca.example.com": {
               "url": "http://localhost:7054",
               "caName": "ca.example.com"
           }
       }
   }
   // 원래는 localhost를 바꿔줘야됨(접속할 ip로)
   ```

   

4. 조직org1의 관리자의 msp를 등록하자

   1. MyWeb/routes/basic_network_router.js 를 수정

   ```javascript
   const express = require('express');
   const router = express.Router();
   
   ///////////////////////////////////////////////////////////////////
   const fs = require('fs');
   const path = require('path');
   
   ///////////////////////////////////////
   // Hyperledger fabric SDK
   // 인증에 관한 서비스를 해주기 때문에 CA라고 이름 붙임
   const FabricCAServices = require('fabric-ca-client');
   const { FileSystemWallet, X509WalletMixin } = require('fabric-network');
   ///////////////////////////////////////
   
   /* GET */
   router.get('/', async(req, res, next) => {
       const ccpPath = path.resolve(__dirname, '..' , 'basic_articles', 'connection.json');
      //ccp란 common connection profile의 약자
       const ccpJSON = fs.readFileSync(ccpPath, 'utf8');
       const ccp = JSON.parse(ccpJSON);
   
       // 인증기관과 통신할 수 있는 객체 생성
       const caURL = ccp.certificateAuthorities['ca.example.com'].url;
       const ca = new FabricCAServices(caURL);	// 실제 ca와 통신하는 객체
   
       // 신원 증명서를 저장할 지갑 생성
       const walletPath = path.join(process.cwd(), 'wallet');
       const wallet = new FileSystemWallet(walletPath);
       console.log(`Wallet path: ${walletPath}`);    
       
       // admin신원 증명서가 있는지 확인
       const adminExists = await wallet.exists('admin');
       if (!adminExists) {
          // Enroll the admin user, and import the new identity into the wallet.
          const enrollment = await ca.enroll({ enrollmentID: 'admin', enrollmentSecret: 'adminpw' });
          // 객체의 요소를 바꿔서 넣음
          // param : connection.json org1의 mspid, admin의 인증서, admin의 공개키
          const identity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
          // 여기서 채워짐
          wallet.import('admin', identity);
          console.log('Successfully enrolled admin user "admin" and imported it into the wallet');
       }   
       res.json({"msg":"ok"});
     });
     
   ///////////////////////////////////////////////////////////////////
   
   module.exports = router;
   ```

   ※package.json의 dependencies에 다음 항목이 있는지 확인하고 없으면 추가한 뒤 npm i 한다

   ```json
   "fabric-ca-client": "~1.4.0",  
   "fabric-client": "~1.4.0",  
   "fabric-network": "^1.4.4",
   ```

   추가 후 `npm i`하자

   ​	

   2. npm start`로 수행해보자

   ![1](https://user-images.githubusercontent.com/20276476/80267005-e8cd1100-86d9-11ea-949d-2db48422f940.png)

   basicNetwork에서 연결 버튼을 눌렀을 때 위와 같은 메시지가 오면 된다

   

   ![2](https://user-images.githubusercontent.com/20276476/80267042-16b25580-86da-11ea-9d4f-9c25ca26f0db.png)

   VSCode에 가보면 wallet의 폴더와 admin 인증서, 개인키, 공개키가 생긴다

   

5. 이제 유저의 msp를 등록 해보자

   1. basic_network_router.js를 다음과 같이 수정

      ```javascript
      const express = require('express');
      const router = express.Router();
      const fs = require('fs');
      const path = require('path');
      
      const FabricCAServices = require('fabric-ca-client');
      //////////////////////////////////////////////////////////////////////
      const { FileSystemWallet, X509WalletMixin, Gateway } = require('fabric-network');
      //////////////////////////////////////////////////////////////////////
      
      /* GET */
      router.get('/', async(req, res, next) => {
          const ccpPath = path.resolve(__dirname, '..' , 'basic_articles', 'connection.json');
          const ccpJSON = fs.readFileSync(ccpPath, 'utf8');
          const ccp = JSON.parse(ccpJSON);
      
          const caURL = ccp.certificateAuthorities['ca.example.com'].url;
          const ca = new FabricCAServices(caURL);
          
          const walletPath = path.join(process.cwd(), 'wallet');
          const wallet = new FileSystemWallet(walletPath);
          console.log(`Wallet path: ${walletPath}`);
          
          const adminExists = await wallet.exists('admin');
          if (!adminExists) {
             // Enroll the admin user, and import the new identity into the wallet.
             const enrollment = await ca.enroll({ enrollmentID: 'admin', enrollmentSecret: 'adminpw' });
             const identity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
             wallet.import('admin', identity);
             console.log('Successfully enrolled admin user "admin" and imported it into the wallet');
      
          }   
      
          ///////////////////////////////////////////////////////////////
          // 지갑에 user1에 대한 신원 증명서가 있는지 확인(없으면 만든다)
          const userExists = await wallet.exists('user1');
          if (!userExists) {
              // 피어 노드로 연결하기 위한 Gateway 객체 생성.
              // admin이 문을 열어준다(admin이 작업을 해줘야 user가 들어갈 수 있음)
              const gateway = new Gateway();
              await gateway.connect(ccp, { wallet, identity: 'admin', discovery: { enabled: false } });
      
              // Gateway를 통해 인증기관 객체를 생성
              const ca = gateway.getClient().getCertificateAuthority();
              const adminIdentity = gateway.getCurrentIdentity();
      
              // user1의 신원 증명
              const secret = await ca.register({ affiliation: 'org1.department1', enrollmentID: 'user1', role: 'client' }, adminIdentity);
              const enrollment = await ca.enroll({ enrollmentID: 'user1', enrollmentSecret: secret });
              // X509WalletMixin -> 일종의 포맷
              const userIdentity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
              wallet.import('user1', userIdentity);
              console.log('Successfully registered and enrolled admin user "user1" and imported it into the wallet');
      
          }
      ///////////////////////////////////////////////////////////////////
          
          res.json({"msg":"ok"});
       });
        
      
      module.exports = router;
      
      ```

      ![3](https://user-images.githubusercontent.com/20276476/80267822-043a1b00-86de-11ea-8d3d-b7d6e091e311.png)

      user의 인증서, 공개키, 개인키가 생성되고 admin에 user1의 공개키가 추가된다

      

6. index.jsx를 수정

   ```react
   
   var {Component} = React;
   var {Router, Route, IndexRoute, Link} = ReactRouter;
    
   class Main extends Component{
       render(){
           return(            
               <div>
                   <h1>Hyperledger Fabric Study</h1>
                   <ul className="header" >
                       <li><Link exact to="/">Home</Link></li>
                       <li><Link to="/basic">BasicNetwork</Link></li>
                       <li><Link to="/first">FirstNetwork</Link></li>
                   </ul>
                   <div className="content">
                   {this.props.children}
                   </div>
               </div>            
           );
       }
   }
    
   class Home extends Component{
       render(){
           return(
               <div>
                   <h2>HELLO</h2>
                   <p>안녕하세요? 하이퍼레저에 접속하는 노드 웹 예제입니다. 잘해보죠~!!!</p>
               </div>
           );
       }
   }
   
   class BasicNetwork extends Component{
       state = {
           amount :0,
       }
   
       // 연결 부분
       basic_network=()=>{
           axios.get('/basic_network')
           .then((response)=>{
               console.log(response);
               
           })
           .catch((error)=>{
               console.log(error);
           });
       }
       
       /////////////////////////////////////////////////////////////
       query=()=>{        
           axios.get('/basic_network/query')
           .then((response)=>{
               console.log(response.data.msg);
               this.setState({amount:response.data.msg});
           })
           .catch((error)=>{
               console.log(error);
           });
       }
   	/////////////////////////////////////////////////////////////
       
       send=()=>{
           alert(this.amount.value);
           axios.post('/basic_network',{"amount":this.amount.value})
           .then((response)=>{
               console.log(response);       
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       render(){
           return(
               <div>
                   <h2>BasicNetwork
                   에 <button onClick={this.basic_network}>연결</button></h2>
                   <br/>
                   <button onClick={this.query}  > a의 잔액 확인</button> {' '} {this.state.amount}원
                   <br/>               
                   <br/> 
                   <div>a가 b에게 {' '}
                   <input placeholder='송금량' ref={ref=>this.amount=ref} />원을 {' '} 
                   <button onClick={this.send}  > 보내기</button><br/>               
                   </div>
    
               </div>
           );
       }
   
   }
   
   class FirstNetwork extends Component{  
       render(){
           return(
               <div>
                   <h2>FirstNetwork에 연결 해보세요</h2>                
               </div>
           );
       }
   }
    
   ReactDOM.render(
       (<Router>
           <Route path="/" component={Main} >   
               <Route path="basic" component={BasicNetwork}/>
               <Route path="first" component={FirstNetwork} />
               <IndexRoute component={Home} />
           </Route>
       </Router>)
       ,document.getElementById("root")
   );
   ```

   

7. basic_network_router.js를 다음과 같이 바꿈

   ```javascript
   const express = require('express');
   const router = express.Router();
   const fs = require('fs');
   const path = require('path');
    
   const FabricCAServices = require('fabric-ca-client');
   const { FileSystemWallet, X509WalletMixin, Gateway } = require('fabric-network');
    
   const ccpPath = path.resolve(__dirname, '..' , 'basic_articles', 'connection.json');
   const ccpJSON = fs.readFileSync(ccpPath, 'utf8');
   const ccp = JSON.parse(ccpJSON);
    
   // Create a new CA client for interacting with the CA.
   const caURL = ccp.certificateAuthorities['ca.example.com'].url;
   const ca = new FabricCAServices(caURL);
    
   // Create a new file system based wallet for managing identities.
   const walletPath = path.join(process.cwd(), 'wallet');
   const wallet = new FileSystemWallet(walletPath);
   console.log(`Wallet path: ${walletPath}`);
    
   /* GET */
   router.get('/', async(req, res, next) => {
       try{
           // Check to see if we've already enrolled the admin user.
           const adminExists = await wallet.exists('admin');
           if (!adminExists) {
           // Enroll the admin user, and import the new identity into the wallet.
           const enrollment = await ca.enroll({ enrollmentID: 'admin', enrollmentSecret: 'adminpw' });
           const identity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
           wallet.import('admin', identity);
           console.log('Successfully enrolled admin user "admin" and imported it into the wallet');
    
           }   
    
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               // Create a new gateway for connecting to our peer node.
               const gateway = new Gateway();
               await gateway.connect(ccp, { wallet, identity: 'admin', discovery: { enabled: false } });
    
               // Get the CA client object from the gateway for interacting with the CA.
               const ca = gateway.getClient().getCertificateAuthority();
               const adminIdentity = gateway.getCurrentIdentity();
    
               // Register the user, enroll the user, and import the new identity into the wallet.
               const secret = await ca.register({ affiliation: 'org1.department1', enrollmentID: 'user1', role: 'client' }, adminIdentity);
               const enrollment = await ca.enroll({ enrollmentID: 'user1', enrollmentSecret: secret });
               const userIdentity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
               wallet.import('user1', userIdentity);
               console.log('Successfully registered and enrolled admin user "user1" and imported it into the wallet');
    
           }
    
           res.json({"msg":"ok"});
       }catch(e){
           console.log(e);
           res.json({"msg":"connect error"});
       }
     });
     
   //////////////////////////////////////////////////////////////////////////
   /* GET */
   router.get('/query', async (req, res, next) => {
       try{
           console.log("query a...");
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               await res.json({'msg':'연결부터 해주세요'});
               return;
           }
    
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccp, { wallet, identity: 'user1', discovery: { enabled: false } });
    
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
    
           // Get the contract from the network.
           const contract = network.getContract('jes_cc_node');
    
           const result = await contract.evaluateTransaction('getBalance','a');
           console.log(`Transaction has been evaluated, result is: ${result.toString()}`);
           res.json({'msg':result.toString()});
       }catch(e){
           console.log(e);
           res.json({'msg':'query error'});
       }
       }
   );
   //////////////////////////////////////////////////////////////////////////// 
   
   /* POST */
   router.post('/send', async (req, res, next) => {
       try{
       console.log("invoke from a to b : ", req.body.amount);
       const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               await res.json({'msg':'연결부터 해주세요'});
               return;
           }
    
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccp, { wallet, identity: 'user1', discovery: { enabled: false } });
    
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
    
           // Get the contract from the network.
           const contract = network.getContract('jes_cc_node');
    
           await contract.submitTransaction('invoke','a','b',`${req.body.amount}`);
           console.log(`Transaction has been submitted`);
           res.json({'msg':'ok'});
       }catch(e){
           console.log(e);
           res.json({'msg':'send error'});
       }
       }
   );
    
   module.exports = router;
   ```

   

8. 확인하는 방법은 2가지

   1. cli

      1. `docker exec -it cli bash`
      2. `peer chaincode list --installed` -> 인스톨 되어 있는지 확인
      3. `peer chaincode list --instantiated -C mychannel` -> instatitate 되었는지 확인
      4. fabric-samples/chaincode/chaincode_example02/node/chaincode_example02.js 열어보기 -> query가 getBalance, invoke가 send로 바뀌어 있는지 확인( 안바뀌어 있으면 실습2의 chaincode 수정을 참고하여 수정해보기)

      

   2. peer에서 직접 확인해보기

      1. `docker exec -it peer0.org1.example.com bash`
      2. `cd /var/hyperledger/production/ledgersData/chains/chains/mychannel`
      3. `ll`로 확인
      4. `/var/hyperledger/production/chaincodes`에 들어가서 `ls`로 확인

   

9. 결과를 봅시다

   ![4](https://user-images.githubusercontent.com/20276476/80268843-a1e51880-86e5-11ea-840f-734b3745e6da.png)

   

10. b의 잔액도 보이게 하자

    1. index.jsx 수정

       ```react
       const {Component}=React;
       const {Router,Route,IndexRoute,Link}=ReactRouter;
        
       class Main extends Component{
           render(){
               return(
                   <div>
                       <h1>Hyperledger Fabric Study</h1>
                       <ul className="header">
                           <li><Link exact to="/">Home</Link></li>
                           <li><Link to="/basic">BasicNetwork</Link></li>
                           <li><Link to="/first">FirstNetwork</Link></li>
                       </ul>
                       
                       
                       <div>
                           {this.props.children}
                       </div>
                   </div>
               );
           }
       }
        
       class Home extends Component{
           render(){
               return(
                   <div>
                       <h2>Home</h2>
                   </div>
               );
           }
       }
       class BasicNetwork extends Component{
           state={
               a_amount:0,
               b_amount:0
           }
        
           basic_network_connect=()=>{
               axios.get('basic_network/connect')
               .then((res)=>{
                   console.log(res);
               })
               .catch((error)=>{
                   console.log(error);
               });
           }
        
           query=()=>{        
               axios.get('/basic_network/query')
               .then((response)=>{
                    this.setState({a_amount:response.data.a_amount, b_amount:response.data.b_amount});
               })
               .catch((error)=>{
                   console.log(error);
               });
           }
        
           send=()=>{
               alert(this.amount.value);
               axios.post('/basic_network/send',{"amount":this.amount.value})
               .then((response)=>{
                   console.log(response);
                   
               })
               .catch((error)=>{
                   console.log(error);
               });
           }
        
           /////////////////////////////////////////////////////////////////
           render(){
               return(
                   <div>
                       <h2>BasicNetwork
                       에 <button onClick={this.basic_network_connect}>연결</button></h2>
                       <br/>
                       <button onClick={this.query}  > 잔액 확인</button> {' '} a : {this.state.a_amount}원 {'    '} b : {this.state.b_amount}원
                       <br/>               
                       <br/> 
                       <div>a가 b에게 {' '}
                       <input placeholder='송금량' ref={ref=>this.amount=ref} />원을 {' '} 
                       <button onClick={this.send}  > 보내기</button><br/>               
                       </div>
        
                   </div>
               );
           }
       /////////////////////////////////////////////////////////////////
       }
        
       class FirstNetwork extends Component{
           render(){
               return(
                   <div>
                       <h2>FirstNetwork</h2>
                   </div>
               );
           }
       }
        
       ReactDOM.render(
           (<Router>
               <Route path="/" component={Main} >
                   <IndexRoute component={Home} />
                   <Route path="basic" component={BasicNetwork} />
                   <Route path="first" component={FirstNetwork} />
               </Route>
           </Router>)
            , document.getElementById("root")
       );
       ```

       

    2. basic_network_router.js 수정

       ```javascript
       const express = require('express');
       const router = express.Router();
       const fs = require('fs');
       const path = require('path');
        
       const FabricCAServices = require('fabric-ca-client');
       const { FileSystemWallet, X509WalletMixin, Gateway } = require('fabric-network');
        
       const ccpPath = path.resolve(__dirname, '..' , 'basic_articles', 'connection.json');
       const ccpJSON = fs.readFileSync(ccpPath, 'utf8');
       const ccp = JSON.parse(ccpJSON);
        
       // Create a new CA client for interacting with the CA.
       const caURL = ccp.certificateAuthorities['ca.example.com'].url;
       const ca = new FabricCAServices(caURL);
        
       // Create a new file system based wallet for managing identities.
       const walletPath = path.join(process.cwd(), 'wallet');
       const wallet = new FileSystemWallet(walletPath);
       console.log(`Wallet path: ${walletPath}`);
       /* GET */
       router.get('/connect', async(req, res, next) => {
           try{
               // Check to see if we've already enrolled the admin user.
               const adminExists = await wallet.exists('admin');
               if (!adminExists) {
               // Enroll the admin user, and import the new identity into the wallet.
               const enrollment = await ca.enroll({ enrollmentID: 'admin', enrollmentSecret: 'adminpw' });
               const identity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
               wallet.import('admin', identity);
               console.log('Successfully enrolled admin user "admin" and imported it into the wallet');
        
               }   
        
               // Check to see if we've already enrolled the user.
               const userExists = await wallet.exists('user1');
               if (!userExists) {
                   // Create a new gateway for connecting to our peer node.
                   const gateway = new Gateway();
                   await gateway.connect(ccp, { wallet, identity: 'admin', discovery: { enabled: false } });
        
                   // Get the CA client object from the gateway for interacting with the CA.
                   const ca = gateway.getClient().getCertificateAuthority();
                   const adminIdentity = gateway.getCurrentIdentity();
        
                   // Register the user, enroll the user, and import the new identity into the wallet.
                   const secret = await ca.register({ affiliation: 'org1.department1', enrollmentID: 'user1', role: 'client' }, adminIdentity);
                   const enrollment = await ca.enroll({ enrollmentID: 'user1', enrollmentSecret: secret });
                   const userIdentity = X509WalletMixin.createIdentity('Org1MSP', enrollment.certificate, enrollment.key.toBytes());
                   wallet.import('user1', userIdentity);
                   console.log('Successfully registered and enrolled admin user "user1" and imported it into the wallet');
        
               }
        
               res.json({"msg":"ok"});
           }catch(e){
               console.log(e);
               res.json({"msg":"connect error"});
           }
         });
         
        
       /* GET */
       router.get('/query', async (req, res, next) => {
           try{
           console.log("query a...");
           const userExists = await wallet.exists('user1');
               if (!userExists) {
                   console.log('An identity for the user "user1" does not exist in the wallet');
                   await res.json({'msg':'연결부터 해주세요'});
                   return;
               }
        
               // Create a new gateway for connecting to our peer node.
               const gateway = new Gateway();
               await gateway.connect(ccp, { wallet, identity: 'user1', discovery: { enabled: false } });
        
               // Get the network (channel) our contract is deployed to.
               const network = await gateway.getNetwork('mychannel');
        
               // Get the contract from the network.
               const contract = network.getContract('jes_cc_node');
        
               const a_result = await contract.evaluateTransaction('getBalance','a');
               const b_result = await contract.evaluateTransaction('getBalance','b');
               console.log(`Transaction has been evaluated, result is: ${a_result.toString()} , ${b_result.toString()}`);
               res.json({'a_amount':a_result.toString(),'b_amount':b_result.toString()});
           }catch(e){
               console.log(e);
               res.json({'msg':'query error'});
           }
           }
       );
        
       /* POST */
       router.post('/send', async (req, res, next) => {
           try{
           console.log("invoke from a to b : ", req.body.amount);
           const userExists = await wallet.exists('user1');
               if (!userExists) {
                   console.log('An identity for the user "user1" does not exist in the wallet');
                   await res.json({'msg':'연결부터 해주세요'});
                   return;
               }
        
               // Create a new gateway for connecting to our peer node.
               const gateway = new Gateway();
               await gateway.connect(ccp, { wallet, identity: 'user1', discovery: { enabled: false } });
        
               // Get the network (channel) our contract is deployed to.
               const network = await gateway.getNetwork('mychannel');
        
               // Get the contract from the network.
               const contract = network.getContract('jes_cc_node');
        
               await contract.submitTransaction('send','a','b',`${req.body.amount}`);
               console.log(`Transaction has been submitted`);
               res.json({'msg':'ok'});
           }catch(e){
               console.log(e);
               res.json({'msg':'send error'});
           }
           }
           );
        
           module.exports = router;    
       ```

       

    3. 결과를 봅시다

       ![5](https://user-images.githubusercontent.com/20276476/80268899-40717980-86e6-11ea-8592-91158cffc369.png)

       

11. 심심하니 화면좀 고쳐봅시다

    1. index.jsx를 수정

       ```react
       const {Component}=React;
       const {Router,Route,IndexRoute,Link}=ReactRouter;
        
       class Main extends Component{
           render(){
               return(
                   <div>
                       <h1>Hyperledger Fabric Study</h1>
                       <ul className="header">
                           <li><Link exact to="/">Home</Link></li>
                           <li><Link to="/basic">BasicNetwork</Link></li>
                           <li><Link to="/first">FirstNetwork</Link></li>
                       </ul>
                       
                       
                       <div>
                           {this.props.children}
                       </div>
                   </div>
               );
           }
       }
        
       class Home extends Component{
           render(){
               return(
                   <div>
                       <h2>Home</h2>
                   </div>
               );
           }
       }
       class BasicNetwork extends Component{
           state={
               a_amount:0,
               b_amount:0
           }
        
           basic_network_connect=()=>{
               axios.get('basic_network/connect')
               .then((res)=>{
                   console.log(res);
               })
               .catch((error)=>{
                   console.log(error);
               });
           }
        
           query=()=>{        
               axios.get('/basic_network/query')
               .then((response)=>{            
                   this.setState({a_amount:response.data.a_amount, b_amount:response.data.b_amount});
               })
               .catch((error)=>{
                   console.log(error);
               });
           }
        
           send=()=>{
               alert(this.amount.value);
               axios.post('/basic_network/send',{"amount":this.amount.value})
               .then((response)=>{
                   console.log(response);
                   
               })
               .catch((error)=>{
                   console.log(error);
               });
           }
        
           render(){
              
               return(
                   <div>
                       <h2>BasicNetwork
                       에 <button onClick={this.basic_network_connect}>연결</button></h2>
                       <br/>
                       <button onClick={this.query}  > 잔액 확인</button> {' '} 
                       a : <Amount bgColor='green' amount={this.state.a_amount}></Amount>
                       b : <Amount bgColor='red' amount={this.state.b_amount}></Amount>
                       <br/>               
                       <br/> 
                       <div>a가 b에게 {' '}
                       <input placeholder='송금량' ref={ref=>this.amount=ref} />원을 {' '} 
                       <button onClick={this.send}  > 보내기</button><br/>               
                       </div>
        
                   </div>
               );
           }
       }
       
       class Amount extends Component{
           render(){
               var amountStyle={
                   padding:10,
                   margin:20,
                   display:"inline-block",
                   backgroundColor: this.props.bgColor,
                   borderRadius: "50%" ,
                   width : this.props.amount,
                   height: this.props.amount,            
                   textAlign: "center"            
               }
               return (
                   <span style={amountStyle}>{this.props.amount}원</span>
               );
           }
       }
        
       class FirstNetwork extends Component{
           render(){
               return(
                   <div>
                       <h2>FirstNetwork</h2>
                   </div>
               );
           }
       }
        
       ReactDOM.render(
           (<Router>
               <Route path="/" component={Main} >
                   <IndexRoute component={Home} />
                   <Route path="basic" component={BasicNetwork} />
                   <Route path="first" component={FirstNetwork} />
               </Route>
           </Router>)
            , document.getElementById("root")
       );
       ```

       

    2. 결과 확인

       ![6](https://user-images.githubusercontent.com/20276476/80268943-7ca4da00-86e6-11ea-92c0-055ef9aef804.png)



* 로컬 MSP와 채널 MSP

  ```text
  peer0.org1.example.com:
      container_name: peer0.org1.example.com
      image: hyperledger/fabric-peer
      environment:
        - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
        - CORE_PEER_ID=peer0.org1.example.com
        - FABRIC_LOGGING_SPEC=info
        - CORE_CHAINCODE_LOGGING_LEVEL=info
        - CORE_PEER_LOCALMSPID=Org1MSP
        - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/peer/
        - CORE_PEER_ADDRESS=peer0.org1.example.com:7051
        # # the following setting starts chaincode containers on the same
        # # bridge network as the peers
        # # https://docs.docker.com/compose/networking/
        - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=${COMPOSE_PROJECT_NAME}_basic
        - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
        - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb:5984
        # The CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME and CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD
        # provide the credentials for ledger to connect to CouchDB.  The username and password must
        # match the username and password set for the associated CouchDB.
        - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=
        - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=
      working_dir: /opt/gopath/src/github.com/hyperledger/fabric
      command: peer node start
      # command: peer node start --peer-chaincodedev=true
      ports:
        - 7051:7051
        - 7053:7053
      volumes:
          - /var/run/:/host/var/run/
          - ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/msp/peer -> 여기에 구성물들이 있다
          - ./crypto-config/peerOrganizations/org1.example.com/users:/etc/hyperledger/msp/users
          - ./config:/etc/hyperledger/configtx
      depends_on:
        - orderer.example.com
        -couchdb
      networks:
        - basic
  ```

  

  ![7](https://user-images.githubusercontent.com/20276476/80271247-8dab1680-86f9-11ea-8055-acbbd9ea33f8.png)

  인증서와 키들을 모아놓은 폴더 -> 자기와 관계된 기관들의 정보가 같이 있다

  ![8](https://user-images.githubusercontent.com/20276476/80271335-46715580-86fa-11ea-9869-c40509fde55a.png)

  cli쪽, 같은것 같지만 구성은 다름



*****



###### IBM Marbles 예제

HLF/fabric-samples/chaincode/marbles02 -> 이거 잘 안돌아감



1. HLF/fabric-samples 경로에서 `git clone https://github.com/IBM-Blockchain/marbles.git --depth 1`로 클론 받음(관련 웹 프로그램)



2. `cd marbles` -> `npm i`

   > 만약 npm 버전이 너무 낮아서 설치가 안된다면 npm i -g npm@5 라고 한 뒤 실행)(==>node_modules가 없으면 npm cache clean --force 라고 한뒤 실행

   

3. config/connection_profile_local.json 를 수정 후 저장

   ```json
   
   {
   	"name": "Docker Compose Network",
   	"x-networkId": "not-important",
   	"x-type": "hlfv1",
   	"description": "Connection Profile for an Hyperledger Fabric network on a local machine",
   	"version": "1.0.0",
   	"client": {
   		"organization": "Org1MSP",
   		"credentialStore": {
               //////////////////////////////////////////////////
   			"path": "/$HOME/HLF/fabric-smaples/hfc-key-store"
               //////////////////////////////////////////////////
   		}
   	},
   	"channels": {
   		"mychannel": {
   			"orderers": [
   				"fabric-orderer"
   			],
   			"peers": {
   				"fabric-peer-org1": {
   					"x-chaincode": {}
   				}
   			},
   			"chaincodes": [
   				"marbles:v4"
   			],
   			"x-blockDelay": 10000
   		}
   	},
   	"organizations": {
   		"Org1MSP": {
   			"mspid": "Org1MSP",
   			"peers": [
   				"fabric-peer-org1"
   			],
   			"certificateAuthorities": [
   				"fabric-ca"
   			],
   			"x-adminCert": {
                   //////////////////////////////////////////////////////////
   				"path": "/$HOME/HLF/fabric-samples/basic-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/admincerts/Admin@org1.example.com-cert.pem"
   			},
   			"x-adminKeyStore": {
   				"path": "/$HOME/HLF/fabric-samples/basic-network/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore/"
                   //////////////////////////////////////////////////////////
   			}
   		}
   	},
   	"orderers": {
   		"fabric-orderer": {
   			"url": "grpc://localhost:7050"
   		}
   	},
   	"peers": {
   		"fabric-peer-org1": {
   			"url": "grpc://localhost:7051",
   			"eventUrl": "grpc://localhost:7053"
   		}
   	},
   	"certificateAuthorities": {
   		"fabric-ca": {
   			"url": "http://localhost:7054",
   			"httpOptions": {
   				"verify": true
   			},
   			"registrar": [
   				{
   					"enrollId": "admin",
   					"enrollSecret": "adminpw"
   				}
   			],
   			"caName": null
   		}
   	}
   }
   ```

   

4. HLF/fabric-samples 디렉토리 밑에 hfc-key-store폴더를 만듦

   `mkdir hfc-key-store`

   

   **Basic-Network이 돌고 있는지 확인**

   

5. 체인코드 설치

   ![9](https://user-images.githubusercontent.com/20276476/80271632-e16b2f00-86fc-11ea-84d6-9b1510da9ef5.png)

   위의 체인코드들을 올릴 것이다

   경로 HLF/fabric-samples/marbles/scripts에서 

   `node install_chaincode.js`



6. instantiate

   `node instantiate_chaincode.js`



7. gulp 설치 -> 빌드 툴(3001번 포트 씀)

   경로 HLF/fabric-samples/marbles에서

   `npm i -g gulp`

   그 후

   `gulp marbles_local`



8. ip:3001로 접속하면 위와 같은 그림이 나온다

   ![10](https://user-images.githubusercontent.com/20276476/80271712-d82e9200-86fd-11ea-8675-03b8d6f43d4a.png)

   Express 클릭



9. +를 눌러 생성이 가능하다

   ![11](https://user-images.githubusercontent.com/20276476/80271750-4d9a6280-86fe-11ea-91f0-e286589c1682.png)



10. 생성된 동그라미를 드래그 앤 드롭하면 옮겨짐(좀 기다려야 된다)

    ![12](https://user-images.githubusercontent.com/20276476/80271768-7b7fa700-86fe-11ea-9d54-734a0def3477.png)

    

    ![13](https://user-images.githubusercontent.com/20276476/80271818-fb0d7600-86fe-11ea-908a-b12fc6062227.png)

    해당 공의 트랜젝션도 확인 가능



11. HLF/fabric-samples/chaincode/marble02/node/marbles_chaincode.js에서 이 내용을 HLF/fabric-samples/chaincode/chaincode_example02/node/chaincode_example02.js에 넣기

    ```javascript
    async getHistoryForKey(stub, args, thisClass) {
    
        if (args.length < 1) {
          throw new Error('Incorrect number of arguments. Expecting 1')
        }
        let key = args[0];
        console.info('- start getHistoryForKey: %s\n', key);
    
        let resultsIterator = await stub.getHistoryForKey(key);
        let method = thisClass['getAllResults'];
        let results = await method(resultsIterator, true);
    
        return Buffer.from(JSON.stringify(results));
    }
    
    async getAllResults(iterator, isHistory) {
        let allResults = [];
        while (true) {
          let res = await iterator.next();
    
          if (res.value && res.value.value.toString()) {
            let jsonRes = {};
            console.log(res.value.value.toString('utf8'));
    
            if (isHistory && isHistory === true) {
              jsonRes.TxId = res.value.tx_id;
              jsonRes.Timestamp = res.value.timestamp;
              jsonRes.IsDelete = res.value.is_delete.toString();
              try {
                jsonRes.Value = JSON.parse(res.value.value.toString('utf8'));
              } catch (err) {
                console.log(err);
                jsonRes.Value = res.value.value.toString('utf8');
              }
            } else {
              jsonRes.Key = res.value.key;
              try {
                jsonRes.Record = JSON.parse(res.value.value.toString('utf8'));
              } catch (err) {
                console.log(err);
                jsonRes.Record = res.value.value.toString('utf8');
              }
            }
            allResults.push(jsonRes);
          }
          if (res.done) {
            console.log('end of data');
            await iterator.close();
            console.info(allResults);
            return allResults;
          }
        }
     }
    ```

    이거는 수정

    ```javascript
    async Invoke(stub) {
        let ret = stub.getFunctionAndParameters();
        console.info(ret);
        let method = this[ret.fcn];
        if (!method) {
          console.log('no method of name:' + ret.fcn + ' found');
          return shim.success();
        }
        try {
          let payload = await method(stub, ret.params, this);// 여기에 this 붙여줌
          return shim.success(payload);
        } catch (err) {
          console.log(err);
          return shim.error(err);
        }
      }
    ```

    혹시 모르니 전체 코드

    ```javascript
    /*
    # Copyright IBM Corp. All Rights Reserved.
    #
    # SPDX-License-Identifier: Apache-2.0
    */
    
    const shim = require('fabric-shim');
    const util = require('util');
    
    var Chaincode = class {
    
      // Initialize the chaincode
      async Init(stub) {
        console.info('========= example02 Init =========');
        let ret = stub.getFunctionAndParameters();
        console.info(ret);
        let args = ret.params;
        // initialise only if 4 parameters passed.
        if (args.length != 4) {
          return shim.error('Incorrect number of arguments. Expecting 4');
        }
    
        let A = args[0];
        let B = args[2];
        let Aval = args[1];
        let Bval = args[3];
    
        if (typeof parseInt(Aval) !== 'number' || typeof parseInt(Bval) !== 'number') {
          return shim.error('Expecting integer value for asset holding');
        }
    
        try {
          await stub.putState(A, Buffer.from(Aval));
          try {
            await stub.putState(B, Buffer.from(Bval));
            return shim.success();
          } catch (err) {
            return shim.error(err);
          }
        } catch (err) {
          return shim.error(err);
        }
      }
    
      async Invoke(stub) {
        let ret = stub.getFunctionAndParameters();
        console.info(ret);
        let method = this[ret.fcn];
        if (!method) {
          console.log('no method of name:' + ret.fcn + ' found');
          return shim.success();
        }
        try {
          let payload = await method(stub, ret.params, this);
          return shim.success(payload);
        } catch (err) {
          console.log(err);
          return shim.error(err);
        }
      }
    
      async invoke(stub, args) {
        if (args.length != 3) {
          throw new Error('Incorrect number of arguments. Expecting 3');
        }
    
        let A = args[0];
        let B = args[1];
        if (!A || !B) {
          throw new Error('asset holding must not be empty');
        }
    
        // Get the state from the ledger
        let Avalbytes = await stub.getState(A);
        if (!Avalbytes) {
          throw new Error('Failed to get state of asset holder A');
        }
        let Aval = parseInt(Avalbytes.toString());
    
        let Bvalbytes = await stub.getState(B);
        if (!Bvalbytes) {
          throw new Error('Failed to get state of asset holder B');
        }
    
        let Bval = parseInt(Bvalbytes.toString());
        // Perform the execution
        let amount = parseInt(args[2]);
        if (typeof amount !== 'number') {
          throw new Error('Expecting integer value for amount to be transaferred');
        }
    
        Aval = Aval - amount;
        Bval = Bval + amount;
        console.info(util.format('Aval = %d, Bval = %d\n', Aval, Bval));
    
        // Write the states back to the ledger
        await stub.putState(A, Buffer.from(Aval.toString()));
        await stub.putState(B, Buffer.from(Bval.toString()));
    
      }
    
      // Deletes an entity from state
      async delete(stub, args) {
        if (args.length != 1) {
          throw new Error('Incorrect number of arguments. Expecting 1');
        }
    
        let A = args[0];
    
        // Delete the key from the state in ledger
        await stub.deleteState(A);
      }
    
      // query callback representing the query of a chaincode
      async query(stub, args) {
        if (args.length != 1) {
          throw new Error('Incorrect number of arguments. Expecting name of the person to query')
        }
    
        let jsonResp = {};
        let A = args[0];
    
        // Get the state from the ledger
        let Avalbytes = await stub.getState(A);
        if (!Avalbytes) {
          jsonResp.error = 'Failed to get state for ' + A;
          throw new Error(JSON.stringify(jsonResp));
        }
    
        jsonResp.name = A;
        jsonResp.amount = Avalbytes.toString();
        console.info('Query Response:');
        console.info(jsonResp);
        return Avalbytes;
      }
    
      
      async getHistoryForKey(stub, args, thisClass) {
    
        if (args.length < 1) {
          throw new Error('Incorrect number of arguments. Expecting 1')
        }
        let key = args[0];
        console.info('- start getHistoryForKey: %s\n', key);
    
        let resultsIterator = await stub.getHistoryForKey(key);
        let method = thisClass['getAllResults'];
        let results = await method(resultsIterator, true);
    
        return Buffer.from(JSON.stringify(results));
      }
    
      async getAllResults(iterator, isHistory) {
        let allResults = [];
        while (true) {
          let res = await iterator.next();
    
          if (res.value && res.value.value.toString()) {
            let jsonRes = {};
            console.log(res.value.value.toString('utf8'));
    
            if (isHistory && isHistory === true) {
              jsonRes.TxId = res.value.tx_id;
              jsonRes.Timestamp = res.value.timestamp;
              jsonRes.IsDelete = res.value.is_delete.toString();
              try {
                jsonRes.Value = JSON.parse(res.value.value.toString('utf8'));
              } catch (err) {
                console.log(err);
                jsonRes.Value = res.value.value.toString('utf8');
              }
            } else {
              jsonRes.Key = res.value.key;
              try {
                jsonRes.Record = JSON.parse(res.value.value.toString('utf8'));
              } catch (err) {
                console.log(err);
                jsonRes.Record = res.value.value.toString('utf8');
              }
            }
            allResults.push(jsonRes);
          }
          if (res.done) {
            console.log('end of data');
            await iterator.close();
            console.info(allResults);
            return allResults;
          }
        }
      }
    
    
    };
    
    shim.start(new Chaincode());
    ```

    

12. cli로 접속

    `docker exec -it cli bash`



13. chaincode 확인 

    `peer chaincode list --installed`



14. 버전에 맞게 install

    `peer chaincode install -n jes_cc_node -v 1.2 -l node -p /opt/gopath/src/github.com/chaincode_example02/node/`



15. upgrade

    `peer chaincode upgrade -n jes_cc_node -v 1.2 -C mychannel -c '{"Args" : ["init", "a", "200", "b", "100"]}'`



16. 잘 들어갔는지 확인 해보자

    `peer chaincode query -n jes_cc_node -C mychannel -c '{"Args" : ["getBalance", "a"]}'`

    

17. 트랜젝션도 확인해보자

    `peer chaincode query -n jes_cc_node -C mychannel -c '{"Args" : ["getHistoryForKey", "a"]}'`

    ![14](https://user-images.githubusercontent.com/20276476/80272696-aa018000-8706-11ea-9ab9-118f95d96065.png)





* delete

  ```javascript
    // Deletes an entity from state
    async delete(stub, args) {
      if (args.length != 1) {
        throw new Error('Incorrect number of arguments. Expecting 1');
      }
  
      let A = args[0];
  
      // Delete the key from the state in ledger
      await stub.deleteState(A);
    }
  ```

  정말 지우는 걸까?

  지우는게 아니라 worldstate에서만 지우고 안보여줌(블럭에는 존재)

​		



* basic-network의 crypto-config

  * orderer, peer 두 조직이 존재

  * 각 역할의 msp 구조는 같지만 값이 다르다

  * cli의 keystore

    ![15](https://user-images.githubusercontent.com/20276476/80274917-e6d67280-8718-11ea-9e16-503a91e6eac8.png)

    peer 조직의 관리자 명찰을 달고 있다(파일 시스템으로 찾아 들어가보면 값이 같다)

    ![17](https://user-images.githubusercontent.com/20276476/80274992-6d8b4f80-8719-11ea-9ef6-68a2297b2268.png)

    

  * peer의 keystore

    ![16](https://user-images.githubusercontent.com/20276476/80274950-27ce8700-8719-11ea-83b2-2f82d4cc5e6d.png)

    여기도 해당 msp를 찾아가보면 값이 같다

    ![18](https://user-images.githubusercontent.com/20276476/80275037-adeacd80-8719-11ea-9a50-23e75ccb9c0d.png)

    



