# Hyperledger 

##### First-network msp 구조

* Orderer 조직
  * 조직 msp
  * 조직관리자 msp
  * 조직 머신 msp
* Peer 조직
  * Org1
    * 조직
    * 조직 관리자
    * 조직 머신1
    * 조직 머신2
  * Org2
    * 조직
    * 조직 관리자
    * 조직 머신1
    * 조직 머신2



byfs : bulid your first networks



*****



###### network 만들어 봅시다

1. 터미널을 열어 `docker ps`



2. 돌고 있는 container가 있으면 `docker rm -f $(docker ps -aq)`(전부 닫는 옵션)



3. `apt install -y tilix` -> 화면 분할 도구 설치



4. `tilix &`



5. `cd HLF/fabric-samples/first-network/`

   configtx.yaml -> tx에 관한 것

   crypto-config.yaml -> msp

   base 폴더 안에 docker-compose-base.yaml과 peer-base.yaml이 있다

   

6. HLF/fabric-samples/bin 에 보면 fabric 실행 도구(?) 들이 있다

   

7. 명령들을 하나하나 볼것 (first-network에서)

   1. 인증서 생성

      `../bin/cryptogen generate --config=./crypto-config.yaml`

      crypto-config 폴더가 생성 됨

      

   2. `cd crypto-config`로 가서 `tree crypto-config`

      * tree 결과

      ```text
      .
      ├── ordererOrganizations
      │   └── example.com
      │       ├── ca
      │       │   ├── ca.example.com-cert.pem
      │       │   └── e6919ddc7948663a81d35786c0177c5b834fca7345e10d30085c389e722f0878_sk
      ///////////////////////////////////////////////////////////////////////
      │       ├── msp
      │       │   ├── admincerts
      │       │   ├── cacerts
      │       │   │   └── ca.example.com-cert.pem
      │       │   ├── config.yaml
      │       │   └── tlscacerts
      │       │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │       ├── orderers
      │       │   ├── orderer.example.com
      ///////////////////////////////////////////////////////////////////////
      │       │   │   ├── msp
      │       │   │   │   ├── admincerts
      │       │   │   │   ├── cacerts
      │       │   │   │   │   └── ca.example.com-cert.pem
      │       │   │   │   ├── config.yaml
      │       │   │   │   ├── keystore
      │       │   │   │   │   └── 03b6a0c3f65b511bc78aabf7ca710c0afd5ded217f3726534f19fb8454614f45_sk
      │       │   │   │   ├── signcerts
      │       │   │   │   │   └── orderer.example.com-cert.pem
      │       │   │   │   └── tlscacerts
      │       │   │   │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │       │   │   └── tls
      │       │   │       ├── ca.crt
      │       │   │       ├── server.crt
      │       │   │       └── server.key
      │       │   ├── orderer2.example.com
      ///////////////////////////////////////////////////////////////////////
      │       │   │   ├── msp
      │       │   │   │   ├── admincerts
      │       │   │   │   ├── cacerts
      │       │   │   │   │   └── ca.example.com-cert.pem
      │       │   │   │   ├── config.yaml
      │       │   │   │   ├── keystore
      │       │   │   │   │   └── f9090a516495e87592fd3f80c1e95527567d1b6090fd3dabd218040e52564de5_sk
      │       │   │   │   ├── signcerts
      │       │   │   │   │   └── orderer2.example.com-cert.pem
      │       │   │   │   └── tlscacerts
      │       │   │   │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │       │   │   └── tls
      │       │   │       ├── ca.crt
      │       │   │       ├── server.crt
      │       │   │       └── server.key
      │       │   ├── orderer3.example.com
      ///////////////////////////////////////////////////////////////////////
      │       │   │   ├── msp
      │       │   │   │   ├── admincerts
      │       │   │   │   ├── cacerts
      │       │   │   │   │   └── ca.example.com-cert.pem
      │       │   │   │   ├── config.yaml
      │       │   │   │   ├── keystore
      │       │   │   │   │   └── 06e5a077914f616e0af479c43dc16e7b496b23410926422bc54a7cfee59e8c2c_sk
      │       │   │   │   ├── signcerts
      │       │   │   │   │   └── orderer3.example.com-cert.pem
      │       │   │   │   └── tlscacerts
      │       │   │   │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │       │   │   └── tls
      │       │   │       ├── ca.crt
      │       │   │       ├── server.crt
      │       │   │       └── server.key
      │       │   ├── orderer4.example.com
      ///////////////////////////////////////////////////////////////////////
      │       │   │   ├── msp
      │       │   │   │   ├── admincerts
      │       │   │   │   ├── cacerts
      │       │   │   │   │   └── ca.example.com-cert.pem
      │       │   │   │   ├── config.yaml
      │       │   │   │   ├── keystore
      │       │   │   │   │   └── 29bf9b5372f1f373dff8a92f90925749e5cac57bd463bd4566ae8044d54e1de5_sk
      │       │   │   │   ├── signcerts
      │       │   │   │   │   └── orderer4.example.com-cert.pem
      │       │   │   │   └── tlscacerts
      │       │   │   │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │       │   │   └── tls
      │       │   │       ├── ca.crt
      │       │   │       ├── server.crt
      │       │   │       └── server.key
      │       │   └── orderer5.example.com
      ///////////////////////////////////////////////////////////////////////
      │       │       ├── msp
      │       │       │   ├── admincerts
      │       │       │   ├── cacerts
      │       │       │   │   └── ca.example.com-cert.pem
      │       │       │   ├── config.yaml
      │       │       │   ├── keystore
      │       │       │   │   └── 37e52af954de6a8f4ae022cef53541f4fd0a9637017b6dd81a47473eb388440c_sk
      │       │       │   ├── signcerts
      │       │       │   │   └── orderer5.example.com-cert.pem
      │       │       │   └── tlscacerts
      │       │       │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │       │       └── tls
      │       │           ├── ca.crt
      │       │           ├── server.crt
      │       │           └── server.key
      │       ├── tlsca
      │       │   ├── 09b5bd259f7668ce111aa313f3838d439d3ab7afc513aaec986bbaa6a995968a_sk
      │       │   └── tlsca.example.com-cert.pem
      │       └── users
      │           └── Admin@example.com
      ///////////////////////////////////////////////////////////////////////
      │               ├── msp
      │               │   ├── admincerts
      │               │   ├── cacerts
      │               │   │   └── ca.example.com-cert.pem
      │               │   ├── config.yaml
      │               │   ├── keystore
      │               │   │   └── 1ee30e6af5a590e58151d8edd683ac847257d352c9995259bc95581d18a4ff25_sk
      │               │   ├── signcerts
      │               │   │   └── Admin@example.com-cert.pem
      │               │   └── tlscacerts
      │               │       └── tlsca.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      │               └── tls
      │                   ├── ca.crt
      │                   ├── client.crt
      │                   └── client.key
      └── peerOrganizations
          ├── org1.example.com
          │   ├── ca
          │   │   ├── ca.org1.example.com-cert.pem
          │   │   └── ea73d863d358e519aace3490a7b168483998316358d6ede32f40708c7e502330_sk
          
      ///////////////////////////////////////////////////////////////////////
          │   ├── msp
          │   │   ├── admincerts
          │   │   ├── cacerts
          │   │   │   └── ca.org1.example.com-cert.pem
          │   │   ├── config.yaml
          │   │   └── tlscacerts
          │   │       └── tlsca.org1.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
          │   ├── peers
          │   │   ├── peer0.org1.example.com
          
      ///////////////////////////////////////////////////////////////////////
          │   │   │   ├── msp
          │   │   │   │   ├── admincerts
          │   │   │   │   ├── cacerts
          │   │   │   │   │   └── ca.org1.example.com-cert.pem
          │   │   │   │   ├── config.yaml
          │   │   │   │   ├── keystore
          │   │   │   │   │   └── d99a5f6daa65b89aeb42f09c86d019c368faf20117a8c39b7c59839b63cbbca1_sk
          │   │   │   │   ├── signcerts
          │   │   │   │   │   └── peer0.org1.example.com-cert.pem
          │   │   │   │   └── tlscacerts
          │   │   │   │       └── tlsca.org1.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
          │   │   │   └── tls
          │   │   │       ├── ca.crt
          │   │   │       ├── server.crt
          │   │   │       └── server.key
          │   │   └── peer1.org1.example.com
          
      ///////////////////////////////////////////////////////////////////////
          │   │       ├── msp
          │   │       │   ├── admincerts
          │   │       │   ├── cacerts
          │   │       │   │   └── ca.org1.example.com-cert.pem
          │   │       │   ├── config.yaml
          │   │       │   ├── keystore
          │   │       │   │   └── cda1713ffa9d525d4b351ed7a4b81a4faff93de4d9a0c38d8e4e42346b4d9d84_sk
          │   │       │   ├── signcerts
          │   │       │   │   └── peer1.org1.example.com-cert.pem
          │   │       │   └── tlscacerts
          │   │       │       └── tlsca.org1.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
          
          │   │       └── tls
          │   │           ├── ca.crt
          │   │           ├── server.crt
          │   │           └── server.key
          │   ├── tlsca
          │   │   ├── 6133fa3c4b6f39ae07f5727416e8ec43544c0dcdf45119949bd0694803000c63_sk
          │   │   └── tlsca.org1.example.com-cert.pem
          │   └── users
          │       ├── Admin@org1.example.com
          
      ///////////////////////////////////////////////////////////////////////
          │       │   ├── msp
          │       │   │   ├── admincerts
          │       │   │   ├── cacerts
          │       │   │   │   └── ca.org1.example.com-cert.pem
          │       │   │   ├── config.yaml
          │       │   │   ├── keystore
          │       │   │   │   └── 2b1ec6c916465250fbed2a0cbd087cef1a8280747b0bdf02cade555b6b5ddc7d_sk
          │       │   │   ├── signcerts
          │       │   │   │   └── Admin@org1.example.com-cert.pem
          │       │   │   └── tlscacerts
          │       │   │       └── tlsca.org1.example.com-cert.pem
      /////////////////////////////////////////////////////////////////////// 
         
          │       │   └── tls
          │       │       ├── ca.crt
          │       │       ├── server.crt
          │       │       └── server.key
          │       └── User1@org1.example.com
      
      ///////////////////////////////////////////////////////////////////////
          │           ├── msp
          │           │   ├── admincerts
          │           │   ├── cacerts
          │           │   │   └── ca.org1.example.com-cert.pem
          │           │   ├── config.yaml
          │           │   ├── keystore
          │           │   │   └── 86092942dcd481b074094b3672661b3dfa42520b0dbd2bf1e161c74877fc8af0_sk
          │           │   ├── signcerts
          │           │   │   └── User1@org1.example.com-cert.pem
          │           │   └── tlscacerts
          │           │       └── tlsca.org1.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
          │           └── tls
          │               ├── ca.crt
          │               ├── client.crt
          │               └── client.key
          └── org2.example.com
              ├── ca
              │   ├── 7a045f2d3db667033ee7ada9b094245f94a5467c193645ba0bba7792381f3e80_sk
              │   └── ca.org2.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
              ├── msp
              │   ├── admincerts
              │   ├── cacerts
              │   │   └── ca.org2.example.com-cert.pem
              │   ├── config.yaml
              │   └── tlscacerts
              │       └── tlsca.org2.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
              ├── peers
              │   ├── peer0.org2.example.com
              
      ///////////////////////////////////////////////////////////////////////
              │   │   ├── msp
              │   │   │   ├── admincerts
              │   │   │   ├── cacerts
              │   │   │   │   └── ca.org2.example.com-cert.pem
              │   │   │   ├── config.yaml
              │   │   │   ├── keystore
              │   │   │   │   └── 1e3a7fe66cc85d725e8de53f07d3dde1aab19c5fe2047b92c3966e7fe7b164df_sk
              │   │   │   ├── signcerts
              │   │   │   │   └── peer0.org2.example.com-cert.pem
              │   │   │   └── tlscacerts
              │   │   │       └── tlsca.org2.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
              │   │   └── tls
              │   │       ├── ca.crt
              │   │       ├── server.crt
              │   │       └── server.key
              │   └── peer1.org2.example.com
              
      ///////////////////////////////////////////////////////////////////////
              │       ├── msp
              │       │   ├── admincerts
              │       │   ├── cacerts
              │       │   │   └── ca.org2.example.com-cert.pem
              │       │   ├── config.yaml
              │       │   ├── keystore
              │       │   │   └── 7e2eab69d872bf38f4e7e63bd3f6201d8acd3e16272a99188fff9d046c6fc209_sk
              │       │   ├── signcerts
              │       │   │   └── peer1.org2.example.com-cert.pem
              │       │   └── tlscacerts
              │       │       └── tlsca.org2.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
              │       └── tls
              │           ├── ca.crt
              │           ├── server.crt
              │           └── server.key
              ├── tlsca
              │   ├── 120affe4794bf423c71f80f9e8eccb203429d64d93c068d463d83f1aed39931a_sk
              │   └── tlsca.org2.example.com-cert.pem
              └── users
                  ├── Admin@org2.example.com
                  
      ///////////////////////////////////////////////////////////////////////
                  │   ├── msp
                  │   │   ├── admincerts
                  │   │   ├── cacerts
                  │   │   │   └── ca.org2.example.com-cert.pem
                  │   │   ├── config.yaml
                  │   │   ├── keystore
                  │   │   │   └── 298a9678ea26dfc2001004763bff8933a2bb89ca299581d125aaff6ba3fa0a30_sk
                  │   │   ├── signcerts
                  │   │   │   └── Admin@org2.example.com-cert.pem
                  │   │   └── tlscacerts
                  │   │       └── tlsca.org2.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
      
                  │   └── tls
                  │       ├── ca.crt
                  │       ├── server.crt
                  │       └── server.key
                  └── User1@org2.example.com
                  
      ///////////////////////////////////////////////////////////////////////
                      ├── msp
                      │   ├── admincerts
                      │   ├── cacerts
                      │   │   └── ca.org2.example.com-cert.pem
                      │   ├── config.yaml
                      │   ├── keystore
                      │   │   └── 61ddd45ef3b27a7497228284166fc5f67f6d4d63e11f869a0e15c831dc8d7082_sk
                      │   ├── signcerts
                      │   │   └── User1@org2.example.com-cert.pem
                      │   └── tlscacerts
                      │       └── tlsca.org2.example.com-cert.pem
      ///////////////////////////////////////////////////////////////////////
                      
                      └── tls
                          ├── ca.crt
                          ├── client.crt
                          └── client.key
      ```

      

      * crypto-config.yaml

      ```yaml
      # Copyright IBM Corp. All Rights Reserved.
      #
      # SPDX-License-Identifier: Apache-2.0
      #
      
      # ---------------------------------------------------------------------------
      # "OrdererOrgs" - Definition of organizations managing orderer nodes
      # ---------------------------------------------------------------------------
      OrdererOrgs:
        # ---------------------------------------------------------------------------
        # Orderer
        # ---------------------------------------------------------------------------
        - Name: Orderer
          Domain: example.com
          EnableNodeOUs: true
          # ---------------------------------------------------------------------------
          # "Specs" - See PeerOrgs below for complete description
          # ---------------------------------------------------------------------------
          Specs:
            - Hostname: orderer
            - Hostname: orderer2
            - Hostname: orderer3
            - Hostname: orderer4
            - Hostname: orderer5
      
      # ---------------------------------------------------------------------------
      # "PeerOrgs" - Definition of organizations managing peer nodes
      # ---------------------------------------------------------------------------
      PeerOrgs:
        # ---------------------------------------------------------------------------
        # Org1
        # ---------------------------------------------------------------------------
        - Name: Org1
          Domain: org1.example.com
          EnableNodeOUs: true
          # ---------------------------------------------------------------------------
          # "Specs"
          # ---------------------------------------------------------------------------
          # Uncomment this section to enable the explicit definition of hosts in your
          # configuration.  Most users will want to use Template, below
          #
          # Specs is an array of Spec entries.  Each Spec entry consists of two fields:
          #   - Hostname:   (Required) The desired hostname, sans the domain.
          #   - CommonName: (Optional) Specifies the template or explicit override for
          #                 the CN.  By default, this is the template:
          #
          #                              "{{.Hostname}}.{{.Domain}}"
          #
          #                 which obtains its values from the Spec.Hostname and
          #                 Org.Domain, respectively.
          # ---------------------------------------------------------------------------
          # Specs:
          #   - Hostname: foo # implicitly "foo.org1.example.com"
          #     CommonName: foo27.org5.example.com # overrides Hostname-based FQDN set above
          #   - Hostname: bar
          #   - Hostname: baz
          # ---------------------------------------------------------------------------
          # "Template"
          # ---------------------------------------------------------------------------
          # Allows for the definition of 1 or more hosts that are created sequentially
          # from a template. By default, this looks like "peer%d" from 0 to Count-1.
          # You may override the number of nodes (Count), the starting index (Start)
          # or the template used to construct the name (Hostname).
          #
          # Note: Template and Specs are not mutually exclusive.  You may define both
          # sections and the aggregate nodes will be created for you.  Take care with
          # name collisions
          # ---------------------------------------------------------------------------
          Template:
            Count: 2
            # Start: 5
            # Hostname: {{.Prefix}}{{.Index}} # default
          # ---------------------------------------------------------------------------
          # "Users"
          # ---------------------------------------------------------------------------
          # Count: The number of user accounts _in addition_ to Admin
          # ---------------------------------------------------------------------------
          Users:
            Count: 1
        # ---------------------------------------------------------------------------
        # Org2: See "Org1" for full specification
        # ---------------------------------------------------------------------------
        - Name: Org2
          Domain: org2.example.com
          EnableNodeOUs: true
          Template:
            Count: 2
          Users:
            Count: 1
      ```

      

8. orderer genesis block 생성

   `FABRIC_CFG_PATH=$PWD` -> config 파일이 어딨다 라고 명시

   `../bin/configtxgen -profile TwoOrgsOrdererGenesis -channelID byfn-sys-channel -outputBlock ./channel-artifacts/genesis.block`

   ![19](https://user-images.githubusercontent.com/20276476/80325751-65debe80-8871-11ea-9329-6a0dc85b89c6.png)

   

   * configtx

     ```yaml
     Organizations:
         - &OrdererOrg
             Name: OrdererOrg
             ID: OrdererMSP
             MSPDir: crypto-config/ordererOrganizations/example.com/msp
             # 읽기, 쓰기 정책(member는 모두라는 것을 뜻함)
             Policies:
                 Readers:
                     Type: Signature
                     Rule: "OR('OrdererMSP.member')"
                 Writers:
                     Type: Signature
                     Rule: "OR('OrdererMSP.member')"
                 Admins:
                     Type: Signature
                     Rule: "OR('OrdererMSP.admin')"
     
         - &Org1
             Name: Org1MSP
             ID: Org1MSP
     
             MSPDir: crypto-config/peerOrganizations/org1.example.com/msp
     
             Policies:
                 Readers:
                     Type: Signature
                     Rule: "OR('Org1MSP.admin', 'Org1MSP.peer', 'Org1MSP.client')"
                 Writers:
                     Type: Signature
                     Rule: "OR('Org1MSP.admin', 'Org1MSP.client')"
                 Admins:
                     Type: Signature
                     Rule: "OR('Org1MSP.admin')"
     
             AnchorPeers:
                 - Host: peer0.org1.example.com
                   Port: 7051
     
         - &Org2
             Name: Org2MSP
             ID: Org2MSP
     
             MSPDir: crypto-config/peerOrganizations/org2.example.com/msp
     
             Policies:
                 Readers:
                     Type: Signature
                     Rule: "OR('Org2MSP.admin', 'Org2MSP.peer', 'Org2MSP.client')"
                 Writers:
                     Type: Signature
                     Rule: "OR('Org2MSP.admin', 'Org2MSP.client')"
                 Admins:
                     Type: Signature
                     Rule: "OR('Org2MSP.admin')"
     
             AnchorPeers:
                 - Host: peer0.org2.example.com
                   Port: 9051
     
     # 채널, orderer에 관한 버전을 명시
     Capabilities:
         Channel: &ChannelCapabilities
             V1_4_3: true
             V1_3: false
             V1_1: false
     
         Orderer: &OrdererCapabilities
             V1_4_2: true
             V1_1: false
     
         Application: &ApplicationCapabilities
             V1_4_2: true
             V1_3: false
             V1_2: false
             V1_1: false
     
     Application: &ApplicationDefaults
         Organizations:
     
         Policies:
             Readers:
                 Type: ImplicitMeta
                 Rule: "ANY Readers"
             Writers:
                 Type: ImplicitMeta
                 Rule: "ANY Writers"
             Admins:
                 Type: ImplicitMeta
                 Rule: "MAJORITY Admins"
     
     	# * -> &로 되어 있는 것을 참조 하겠다
     	# &ApplicationCapabilities를 참고해서 <<(여기 가져 온다는 것)
         Capabilities:
             <<: *ApplicationCapabilities
     
     Orderer: &OrdererDefaults
         OrdererType: solo
     
         Addresses:
             - orderer.example.com:7050
     
         BatchTimeout: 2s
     
     	# 트랜젝션 max 10, 블럭 크기 99MB, max byte 512kb
         BatchSize:
             MaxMessageCount: 10
             AbsoluteMaxBytes: 99 MB
             PreferredMaxBytes: 512 KB
     
         Kafka:
             Brokers:
                 - 127.0.0.1:9092
     
         Organizations:
     
         Policies:
             Readers:
                 Type: ImplicitMeta
                 Rule: "ANY Readers"
             Writers:
                 Type: ImplicitMeta
                 Rule: "ANY Writers"
             Admins:
                 Type: ImplicitMeta
                 Rule: "MAJORITY Admins"
     
             BlockValidation:
                 Type: ImplicitMeta
                 Rule: "ANY Writers"
     
     Channel: &ChannelDefaults
         Policies:
             Readers:
                 Type: ImplicitMeta
                 Rule: "ANY Readers"
             Writers:
                 Type: ImplicitMeta
                 Rule: "ANY Writers"
             Admins:
                 Type: ImplicitMeta
                 Rule: "MAJORITY Admins"
     
     	# import
         Capabilities:
             <<: *ChannelCapabilities
     
     Profiles:
     	# 명령어에서 명시 했던 것
     	# 여기 있는 정의를 따르겠다
         TwoOrgsOrdererGenesis:
             <<: *ChannelDefaults
             Orderer:
                 <<: *OrdererDefaults
                 Organizations:
                     - *OrdererOrg
                 Capabilities:
                     <<: *OrdererCapabilities
             Consortiums:
                 SampleConsortium:
                     Organizations:
                         - *Org1
                         - *Org2
         TwoOrgsChannel:
             Consortium: SampleConsortium
             <<: *ChannelDefaults
             Application:
                 <<: *ApplicationDefaults
                 Organizations:
                     - *Org1
                     - *Org2
                 Capabilities:
                     <<: *ApplicationCapabilities
     
         SampleDevModeKafka:
             <<: *ChannelDefaults
             Capabilities:
                 <<: *ChannelCapabilities
             Orderer:
                 <<: *OrdererDefaults
                 OrdererType: kafka
                 Kafka:
                     Brokers:
                     - kafka.example.com:9092
     
                 Organizations:
                 - *OrdererOrg
                 Capabilities:
                     <<: *OrdererCapabilities
             Application:
                 <<: *ApplicationDefaults
                 Organizations:
                 - <<: *OrdererOrg
             Consortiums:
                 SampleConsortium:
                     Organizations:
                     - *Org1
                     - *Org2
     
         SampleMultiNodeEtcdRaft:
             <<: *ChannelDefaults
             Capabilities:
                 <<: *ChannelCapabilities
             Orderer:
                 <<: *OrdererDefaults
                 OrdererType: etcdraft
                 EtcdRaft:
                     Consenters:
                     - Host: orderer.example.com
                       Port: 7050
                       ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt
                       ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt
                     - Host: orderer2.example.com
                       Port: 7050
                       ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt
                       ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer2.example.com/tls/server.crt
                     - Host: orderer3.example.com
                       Port: 7050
                       ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt
                       ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer3.example.com/tls/server.crt
                     - Host: orderer4.example.com
                       Port: 7050
                       ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt
                       ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer4.example.com/tls/server.crt
                     - Host: orderer5.example.com
                       Port: 7050
                       ClientTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt
                       ServerTLSCert: crypto-config/ordererOrganizations/example.com/orderers/orderer5.example.com/tls/server.crt
                 Addresses:
                     - orderer.example.com:7050
                     - orderer2.example.com:7050
                     - orderer3.example.com:7050
                     - orderer4.example.com:7050
                     - orderer5.example.com:7050
     
                 Organizations:
                 - *OrdererOrg
                 Capabilities:
                     <<: *OrdererCapabilities
             Application:
                 <<: *ApplicationDefaults
                 Organizations:
                 - <<: *OrdererOrg
             Consortiums:
                 SampleConsortium:
                     Organizations:
                     - *Org1
                     - *Org2
     ```

     genesis block에 이러한 정보들이 기입 된다



9. 채널 트랜젝션 아티팩트 생성

   `export CHANNEL_NAME=mychannel`

   `../bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME`

   ![1](https://user-images.githubusercontent.com/20276476/80326357-742dda00-8873-11ea-9728-710384c11dee.png)

   ```text
   TwoOrgsChannel:
           Consortium: SampleConsortium
           <<: *ChannelDefaults
           Application:
               <<: *ApplicationDefaults
               Organizations:
                   - *Org1
                   - *Org2
               Capabilities:
                   <<: *ApplicationCapabilities
   ```

   이부분을 반영함

   channel.tx파일이 생성 됨

   * channel.tx

     ![2](https://user-images.githubusercontent.com/20276476/80326438-bb1bcf80-8873-11ea-8c28-f73c7d7c0cf9.png)

     

     

10. Org1과 Org2에 대한 Anchor peer 아티팩트를 생성

    * Org1

    `../bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org1MSP`

    

    * Org2

    `../bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org2MSP`



​		다음 두 파일이 생성 됨(내용은 알아 볼 수 없다)

![3](https://user-images.githubusercontent.com/20276476/80326525-06ce7900-8874-11ea-9e40-66b1cb4e10d5.png)



11. fabric 네트워크 가동

    * orderer 1, endorser 4, cli 총 5개의 docker container를 가동해야 함

    1. 6개의 컨테이너 생성

       `docker-compose -f docker-compose-cli.yaml up -d`

       * 해당 docker-compose-cli.yaml의 내용

         ```yaml
         # Copyright IBM Corp. All Rights Reserved.
         #
         # SPDX-License-Identifier: Apache-2.0
         #
         
         version: '2'
         
         volumes:
           orderer.example.com:
           peer0.org1.example.com:
           peer1.org1.example.com:
           peer0.org2.example.com:
           peer1.org2.example.com:
         
         networks:
           byfn:
         
         services:
         
           orderer.example.com:
             extends:
            	  # 해당 파일 참조함
               file:   base/docker-compose-base.yaml	
               service: orderer.example.com
             container_name: orderer.example.com
             networks:
               - byfn
         
           peer0.org1.example.com:
             container_name: peer0.org1.example.com
             extends:
               file:  base/docker-compose-base.yaml
               service: peer0.org1.example.com
             networks:
               - byfn
         
           peer1.org1.example.com:
             container_name: peer1.org1.example.com
             extends:
               file:  base/docker-compose-base.yaml
               service: peer1.org1.example.com
             networks:
               - byfn
         
           peer0.org2.example.com:
             container_name: peer0.org2.example.com
             extends:
               file:  base/docker-compose-base.yaml
               service: peer0.org2.example.com
             networks:
               - byfn
         
           peer1.org2.example.com:
             container_name: peer1.org2.example.com
             extends:
               file:  base/docker-compose-base.yaml
               service: peer1.org2.example.com
             networks:
               - byfn
         
           cli:
             container_name: cli
             image: hyperledger/fabric-tools:$IMAGE_TAG
             tty: true
             stdin_open: true
             environment:
               - SYS_CHANNEL=$SYS_CHANNEL
               - GOPATH=/opt/gopath
               - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
               #- FABRIC_LOGGING_SPEC=DEBUG
               - FABRIC_LOGGING_SPEC=INFO
               - CORE_PEER_ID=cli
               - CORE_PEER_ADDRESS=peer0.org1.example.com:7051
               - CORE_PEER_LOCALMSPID=Org1MSP
               - CORE_PEER_TLS_ENABLED=true
               - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt
               - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key
               - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
               - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
             working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
             command: /bin/bash
             volumes:
                 - /var/run/:/host/var/run/
                 - ./../chaincode/:/opt/gopath/src/github.com/chaincode
                 - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/
                 - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/
                 - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
             depends_on:
               - orderer.example.com
               - peer0.org1.example.com
               - peer1.org1.example.com
               - peer0.org2.example.com
               - peer1.org2.example.com
             networks:
               - byfn
         ```

         >  CLI를 통해 채널 생성 및 체인코드와 관련된 명령어를 실행하기 위해서는 각 피어에 대한 환경변수 값을 알고 있어야 하며, 다음의 환경변수들을 앞으로 나올 명령에서 활용한다.
         >
         > 
         >
         > * CORE_PEER_MSPCONFIGPATH
         > * CORE_PEER_ADDRESS
         > * CORE_PEER_LOCALMSPID
         > * CORE_PEER_TLS_ROOTCERT_FILE

         

         > 판에 대한 이해가  필요해서 공부 하는 것
         >
         > 판을 이해해야 요청을 보낼 때 어떤식으로 보내는 지 알아야 만들 수 있다

       ![4](https://user-images.githubusercontent.com/20276476/80326983-8a3c9a00-8875-11ea-8398-c7c36fabf89e.png)

       6개의 container가 띄워짐

       * cli는 docker-compose-cli에 적혀있어서 띄워짐
       * `CORE_PEER_LOCALMSPID=Org1MSP` -> 조직 1의 명찰을 가짐

       * `CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp` -> 조직 1의 admin명찰을 가짐

       

    2. cli 컨테이너로 입장

       tilix의 새 터미널을 만들고 입장한다

       `docker exec -it cli bash`

       ![5](https://user-images.githubusercontent.com/20276476/80327324-ac82e780-8876-11ea-814b-58285ee4cec5.png)

       

    3. 밑의 id값에 기타 -> 레이아웃 옵션으로 들어가서 제목을 다음과 같이 바꿈

       ![6](https://user-images.githubusercontent.com/20276476/80327401-f23fb000-8876-11ea-890a-e9d2a91dfa8c.png)

       이렇게 하면 명령 칠때 구분하기 쉽다

       그리고 채널 생성함

       `export CHANNEL_NAME=mychannel`

       `peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem`

       pem 파일은 orderer의 공개키가 있음

       orderer가 mychannel.block을 가지게 됨(orderer만 채널을 알고 있다)

       CA가 없고 crypto-gen을 이용하여 인증서를 만들었다

       

    4. 채널에 피어들을 참여시켜야 됨

       아까 위에 있던 환경변수들을 참고하여 설정을 해줌(cli)

       * org1의 Peer0

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
         CORE_PEER_ADDRESS=peer0.org1.example.com:7051
         CORE_PEER_LOCALMSPID="Org1MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
         
         peer channel join -b $CHANNEL_NAME.block -> 참여
         ```

         

       * org1의 Peer1

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
         CORE_PEER_ADDRESS=peer1.org1.example.com:8051
         CORE_PEER_LOCALMSPID="Org1MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls/ca.crt
         
         peer channel join -b $CHANNEL_NAME.block
         ```

         

       * org2의 Peer0

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
         CORE_PEER_ADDRESS=peer0.org2.example.com:9051
         CORE_PEER_LOCALMSPID="Org2MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
         
         peer channel join -b $CHANNEL_NAME.block
         ```

         

       * org2의 Peer1

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
         CORE_PEER_ADDRESS=peer1.org2.example.com:10051
         CORE_PEER_LOCALMSPID="Org2MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls/ca.crt
         
         peer channel join -b $CHANNEL_NAME.block
         ```

         

       

    5. Anchor 피어 설정

       * Peer0.org1 환경변수 설정

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
         CORE_PEER_ADDRESS=peer0.org1.example.com:7051
         CORE_PEER_LOCALMSPID="Org1MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
         
         peer channel create -o orderer.example.com:7050 -c  $CHANNEL_NAME -f ./channel-artifacts/Org1MSPanchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
         ```

         

       * Peer0.org2 환경변수 설정

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
         CORE_PEER_ADDRESS=peer0.org2.example.com:9051
         CORE_PEER_LOCALMSPID="Org2MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
         
         peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org2MSPanchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
         ```

         

       

    6. 체인코드 install

       * Peer0.org1

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
         CORE_PEER_ADDRESS=peer0.org1.example.com:7051
         CORE_PEER_LOCALMSPID="Org1MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
         
         peer chaincode install -n mycc -v 1.0 -p github.com/chaincode/chaincode_example02/go
         ```

         

       * Peer0.org2

         ```text
         CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
         CORE_PEER_ADDRESS=peer0.org2.example.com:9051
         CORE_PEER_LOCALMSPID="Org2MSP"
         CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
         
         peer chaincode install -n mycc -v 1.0 -p github.com/chaincode/chaincode_example02/go
         ```

       

    7. 체인코드 초기화

       ```text
       ## Peer0.org1 환경변수 설정 
       CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
       CORE_PEER_ADDRESS=peer0.org1.example.com:7051
       CORE_PEER_LOCALMSPID="Org1MSP"
       CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
       
       peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n mycc -v 1.0 -c '{"Args":["init","a", "100", "b","200"]}' -P "AND ('Org1MSP.member','Org2MSP.member')"
       ```

       다음 명령을 통해 체인코드를 초기화한다. 체인코드를 초기화 할 때는 Endorsement 정책을 설정하게 되는데, 아래의 명령어 중 -P 옵션이 의미하는 바가 Endorsement 정책이다. 설정되어야 할Endorsement 정책의 내용은 클라이언트에 의해 트랜잭션 제안을 할 때 검증 받아야 할 피어들의 조건들이다. 피어는 트랜잭션을 검증하는 과정 에서 가장 중요한 단계 중 하나가 체인코드를 실행해 보는 것이다. 아래 명령어에서 명시된 조건은 트랜잭션이 Org1 와 Org2 에 포함되는 피어들 중 각 조직에서 하나의 피어 이상에서 서명을 받으면 정당한 트랜잭션으로 판단되는 내용이다. 또한 초기값으로 a 에 100, b 에 200을 블록체인에 입력한다 -> 이거 뭔소린지 정리하기

       instantiate는 하나만 해도 충분 Why? -> channel에 알리는 것이기 때문에



###### 이제 쿼리를 날려봅시다

1. 입력 값 조회(query)

   ```text
   ## Peer0.org1 환경변수 설정
   CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
   CORE_PEER_ADDRESS=peer0.org1.example.com:7051
   CORE_PEER_LOCALMSPID="Org1MSP"
   CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
   
   peer chaincode query -C $CHANNEL_NAME -n mycc -c '{"Args":["query","a"]}'
   ```

   peer1.org1으로 하면 500 에러남 -> chaincode가 없어서

   

2. invork해보자

   ```text
   peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n mycc --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses peer0.org2.example.com:9051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"Args":["invoke","a","b","10"]}'
   ```



* 프로비저닝 한다 -> 네트워크를 가동시킨다

* balanceTransfer 예제는 out of memory 오류가 난다



*****



###### 다른 체인 코드(fabcar)를 사용해보자

경로는 HLF/fabric-samples/chaincode/fabcar에 있음

1. HLF/fabric-sample/fabcar/startFabric.sh 을 확인

   ```bash
   #!/bin/bash
   #
   # Copyright IBM Corp All Rights Reserved
   #
   # SPDX-License-Identifier: Apache-2.0
   #
   # Exit on first error
   set -e
   
   # don't rewrite paths for Windows Git Bash users
   export MSYS_NO_PATHCONV=1
   starttime=$(date +%s)
   CC_SRC_LANGUAGE=${1:-"go"}
   CC_SRC_LANGUAGE=`echo "$CC_SRC_LANGUAGE" | tr [:upper:] [:lower:]`
   if [ "$CC_SRC_LANGUAGE" = "go" -o "$CC_SRC_LANGUAGE" = "golang"  ]; then
   	CC_RUNTIME_LANGUAGE=golang
   	CC_SRC_PATH=github.com/chaincode/fabcar/go
   elif [ "$CC_SRC_LANGUAGE" = "java" ]; then
   	CC_RUNTIME_LANGUAGE=java
   	CC_SRC_PATH=/opt/gopath/src/github.com/chaincode/fabcar/java
   elif [ "$CC_SRC_LANGUAGE" = "javascript" ]; then
   	CC_RUNTIME_LANGUAGE=node # chaincode runtime language is node.js
   	CC_SRC_PATH=/opt/gopath/src/github.com/chaincode/fabcar/javascript
   elif [ "$CC_SRC_LANGUAGE" = "typescript" ]; then
   	CC_RUNTIME_LANGUAGE=node # chaincode runtime language is node.js
   	CC_SRC_PATH=/opt/gopath/src/github.com/chaincode/fabcar/typescript
   	echo Compiling TypeScript code into JavaScript ...
   	pushd ../chaincode/fabcar/typescript
   	npm install
   	npm run build
   	popd
   	echo Finished compiling TypeScript code into JavaScript
   else
   	echo The chaincode language ${CC_SRC_LANGUAGE} is not supported by this script
   	echo Supported chaincode languages are: go, javascript, and typescript
   	exit 1
   fi
   
   ######################################################################
   # fabcar/javascript/wallet이 생긴다
   # clean the keystore
   #rm -rf ./hfc-key-store
   rm -rf ./javascript/wallet
   
   # launch network; create channel and join peer to channel
   cd ../first-network
   echo y | ./byfn.sh –m down	# 돌고 있는 것들 다 다운시켜라
   echo y | ./byfn.sh up -a -n -s couchdb
   ######################################################################
   
   CONFIG_ROOT=/opt/gopath/src/github.com/hyperledger/fabric/peer
   ORG1_MSPCONFIGPATH=${CONFIG_ROOT}/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
   ORG1_TLS_ROOTCERT_FILE=${CONFIG_ROOT}/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
   ORG2_MSPCONFIGPATH=${CONFIG_ROOT}/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
   ORG2_TLS_ROOTCERT_FILE=${CONFIG_ROOT}/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
   ORDERER_TLS_ROOTCERT_FILE=${CONFIG_ROOT}/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
   set -x
   
   ######################################################################
   # interaction 안하겠다
   # cli를 통해 chaincode install을 바로 한다
   echo "Installing smart contract on peer0.org1.example.com"
   docker exec \
     -e CORE_PEER_LOCALMSPID=Org1MSP \
     -e CORE_PEER_ADDRESS=peer0.org1.example.com:7051 \
     -e CORE_PEER_MSPCONFIGPATH=${ORG1_MSPCONFIGPATH} \
     -e CORE_PEER_TLS_ROOTCERT_FILE=${ORG1_TLS_ROOTCERT_FILE} \
     cli \
     peer chaincode install \
       -n fabcar \
       -v 1.0 \
       -p "$CC_SRC_PATH" \
       -l "$CC_RUNTIME_LANGUAGE"
   
   echo "Installing smart contract on peer1.org1.example.com"
   docker exec \
     -e CORE_PEER_LOCALMSPID=Org1MSP \
     -e CORE_PEER_ADDRESS=peer1.org1.example.com:8051 \
     -e CORE_PEER_MSPCONFIGPATH=${ORG1_MSPCONFIGPATH} \
     -e CORE_PEER_TLS_ROOTCERT_FILE=${ORG1_TLS_ROOTCERT_FILE} \
     cli \
     peer chaincode install \
       -n fabcar \
       -v 1.0 \
       -p "$CC_SRC_PATH" \
       -l "$CC_RUNTIME_LANGUAGE"
   
   echo "Installing smart contract on peer0.org2.example.com"
   docker exec \
     -e CORE_PEER_LOCALMSPID=Org2MSP \
     -e CORE_PEER_ADDRESS=peer0.org2.example.com:9051 \
     -e CORE_PEER_MSPCONFIGPATH=${ORG2_MSPCONFIGPATH} \
     -e CORE_PEER_TLS_ROOTCERT_FILE=${ORG2_TLS_ROOTCERT_FILE} \
     cli \
     peer chaincode install \
       -n fabcar \
       -v 1.0 \
       -p "$CC_SRC_PATH" \
       -l "$CC_RUNTIME_LANGUAGE"
   
   echo "Installing smart contract on peer1.org2.example.com"
   docker exec \
     -e CORE_PEER_LOCALMSPID=Org2MSP \
     -e CORE_PEER_ADDRESS=peer1.org2.example.com:10051 \
     -e CORE_PEER_MSPCONFIGPATH=${ORG2_MSPCONFIGPATH} \
     -e CORE_PEER_TLS_ROOTCERT_FILE=${ORG2_TLS_ROOTCERT_FILE} \
     cli \
     peer chaincode install \
       -n fabcar \
       -v 1.0 \
       -p "$CC_SRC_PATH" \
       -l "$CC_RUNTIME_LANGUAGE"
   #####################################################################
   
   #####################################################################
   # Instantiate
   echo "Instantiating smart contract on mychannel"
   docker exec \
     -e CORE_PEER_LOCALMSPID=Org1MSP \
     -e CORE_PEER_MSPCONFIGPATH=${ORG1_MSPCONFIGPATH} \
     cli \
     peer chaincode instantiate \
       -o orderer.example.com:7050 \
       -C mychannel \
       -n fabcar \
       -l "$CC_RUNTIME_LANGUAGE" \
       -v 1.0 \
       # Args를 안줌(init method에)
       -c '{"Args":[]}' \			
       -P "AND('Org1MSP.member','Org2MSP.member')" \
       --tls \
       --cafile ${ORDERER_TLS_ROOTCERT_FILE} \
       --peerAddresses peer0.org1.example.com:7051 \
       --tlsRootCertFiles ${ORG1_TLS_ROOTCERT_FILE}
   #####################################################################
   
   echo "Waiting for instantiation request to be committed ..."
   sleep 10
   
   #####################################################################
   # chaincode invoke
   echo "Submitting initLedger transaction to smart contract on mychannel"
   echo "The transaction is sent to all of the peers so that chaincode is built before receiving the following requests"
   docker exec \
     -e CORE_PEER_LOCALMSPID=Org1MSP \
     -e CORE_PEER_MSPCONFIGPATH=${ORG1_MSPCONFIGPATH} \
     cli \
     peer chaincode invoke \
       -o orderer.example.com:7050 \
       -C mychannel \
       -n fabcar \
       # invoke로 initLedger를 함
       # 방법 1: "function": ~, "Args": [~]
       # 방법 2: "Args": ["[function name]", "param1",...]
       -c '{"function":"initLedger","Args":[]}' \
       --waitForEvent \
       --tls \
       --cafile ${ORDERER_TLS_ROOTCERT_FILE} \
       --peerAddresses peer0.org1.example.com:7051 \
       --peerAddresses peer1.org1.example.com:8051 \
       --peerAddresses peer0.org2.example.com:9051 \
       --peerAddresses peer1.org2.example.com:10051 \
       --tlsRootCertFiles ${ORG1_TLS_ROOTCERT_FILE} \
       --tlsRootCertFiles ${ORG1_TLS_ROOTCERT_FILE} \
       --tlsRootCertFiles ${ORG2_TLS_ROOTCERT_FILE} \
       --tlsRootCertFiles ${ORG2_TLS_ROOTCERT_FILE}
   set +x
   
   cat <<EOF
   
   Total setup execution time : $(($(date +%s) - starttime)) secs ...
   
   Next, use the FabCar applications to interact with the deployed FabCar contract.
   The FabCar applications are available in multiple programming languages.
   Follow the instructions for the programming language of your choice:
   
   ######################################################################
   # 어떻게 돌리는지 순서를 알려줌
   JavaScript:
   
     Start by changing into the "javascript" directory:
       cd javascript
   
     Next, install all required packages:
       npm install
   
     Then run the following applications to enroll the admin user, and register a new user
     called user1 which will be used by the other applications to interact with the deployed
     FabCar contract:
       node enrollAdmin
       node registerUser
   
     You can run the invoke application as follows. By default, the invoke application will
     create a new car, but you can update the application to submit other transactions:
       node invoke
   
     You can run the query application as follows. By default, the query application will
     return all cars, but you can update the application to evaluate other transactions:
       node query
   
   TypeScript:
   
     Start by changing into the "typescript" directory:
       cd typescript
   
     Next, install all required packages:
       npm install
   
     Next, compile the TypeScript code into JavaScript:
       npm run build
   
     Then run the following applications to enroll the admin user, and register a new user
     called user1 which will be used by the other applications to interact with the deployed
     FabCar contract:
       node dist/enrollAdmin
       node dist/registerUser
   
     You can run the invoke application as follows. By default, the invoke application will
     create a new car, but you can update the application to submit other transactions:
       node dist/invoke
   
     You can run the query application as follows. By default, the query application will
     return all cars, but you can update the application to evaluate other transactions:
       node dist/query
   
   Java:
   
     Start by changing into the "java" directory:
       cd java
   
     Then, install dependencies and run the test using:
       mvn test
   
     The test will invoke the sample client app which perform the following:
       - Enroll admin and user1 and import them into the wallet (if they don't already exist there)
       - Submit a transaction to create a new car
       - Evaluate a transaction (query) to return details of this car
       - Submit a transaction to change the owner of this car
       - Evaluate a transaction (query) to return the updated details of this car
   
   EOF
   ```

   

2. fabric-samples/fabcar에서 돌릴 것

   javascript/wallet에 있는 코드 중 위에 shim이 있어야 chaincode임

   chinecode/fabcar/javascript-low-level/fabcar.js에 shim이라고 적혀잇음

   즉

   fabric-samples/fabcar/javascript/wallet에 있는 코드는 클라이언트 코드

   chinecode/fabcar/javascript-low-level/에 있는 것이 체인 코드



3. /HLF/fabric-samples/fabcar로 가서(ubuntu)

   `./startFabric.sh javascript`

   first-network 가동됨. 

   fabcar체인코드(javascript라고 하면 nodejs 코드가 설치됨) 설치됨.

   couchDB와 CA container도 가동됨

   완료된 후 `docker ps`

   ![7](https://user-images.githubusercontent.com/20276476/80335311-e4962480-888e-11ea-87fe-04a2b8beeef8.png)

   

4. `cd javascript` -> `npm i` 

   `npm i`전에 package.json을 보면  "dependencies"에 fabric SDK가 있는걸 확인



5. `node enrollAdmin.js` 후 wallet 폴더 확인

   ![8](https://user-images.githubusercontent.com/20276476/80335632-d399e300-888f-11ea-9afa-17479291751b.png)

   admin의 개인, 공개키와 인증서 생성됨

   -> user의 참여를 위해선 admin이 필요함

   

6. `node registerUser.js`

   ![9](https://user-images.githubusercontent.com/20276476/80335676-004dfa80-8890-11ea-9cd3-e224768539d8.png)

   user정보가 생성됨



7. query 해보기 - 모든 차량 정보 조회

   `node query.js`

   ![11](https://user-images.githubusercontent.com/20276476/80335758-3d19f180-8890-11ea-8807-b0b0c432ed39.png)

   

   물론 couchdb에서도 볼 수 있다

   ![12](https://user-images.githubusercontent.com/20276476/80335827-65a1eb80-8890-11ea-8b1f-6f1957f52d42.png)

   

8. invoke도 해봅시다

   invoke.js에 submittransaction 부분의 2번째 param을 CAR10으로 변경후

   `node invoke.js`

   couchdb에서 확인해보면

   ![13](https://user-images.githubusercontent.com/20276476/80335957-ce896380-8890-11ea-8bc5-894685180d3e.png)

   CAR10이 추가 된 것을 볼 수 있다



9. 한 peer를 꺼보자

   `docker stop peer0.org2.example.com`

   `docker stop peer1.org2.example.com`

   

10. `node query.js` 해보자

    

11. invoke.js 에서 아까 그 부분을 CAR11로 변경후 저장



12. `node invoke.js`

    ![14](https://user-images.githubusercontent.com/20276476/80337905-06df7080-8896-11ea-9afd-ee52f16dc2c0.png)

    `await contract.submitTransaction('createCar', 'CAR11', 'Honda', 'Accord', 'Black', 'Tom');`

    여기서 오류 난다

    보증 정책에 어긋나기 때문에 reject됨(orderer가 블럭을 만들어서 보내도)

    보증 정책을 AND가 아니라 OR로 하면 된다



13. query.js에서 

    `const result = await contract.evaluateTransaction('queryCar', 'CAR0');`

    부분을

    `const result = await contract.evaluateTransaction('queryCar', 'CAR0');`

    로 바꾼 뒤 저장하면 'CAR0'에 해당하는 값만 조회가 가능해진다

    ![15](https://user-images.githubusercontent.com/20276476/80339943-a7d02a80-889a-11ea-929b-39da55accbc2.png)

    

*****



