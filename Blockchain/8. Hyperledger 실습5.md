# Hyperledger



###### emdorsement 정책을 바꾸어 봅시다

1. HLF/fabric-samples/fabcar/startFabric.sh참고

   first-network 경로에서 `./byfn.sh -m down`로 컨테이너를 끄고

   instantiating 부분의 -p(policy) 부분의 AND를 OR로 바꾼 후 저장



2. fabcar에서`./startFabric javascript`로 재 가동

3. 다른 cmd창에서 `docker exec -it cli bash`로 cli 접속

4. cd javascript

5. npm i

6. node enrollAdmin.js

7. node registerUser.js

8. node query.js 

9. node invoke.js

10. node query.js 

11. docker stop peer0.org2.example.com

    docker stop peer1.org2.example.com

12. invoke.js에서 CAR12를 CAR11로 바꾸고 저장 후 `node invoke.js`

13. `node query.js`로 확인해보면 오류없이 query 수행

    ![16](https://user-images.githubusercontent.com/20276476/80433929-54f68180-8933-11ea-9d9d-343f806083ad.png)



*****



###### policy를 admin으로 바꾸어 보자

1. startFabirc.js파을을 열어

   정책 부분을

   `-P "OR('Org1MSP.admin','Org2MSP.admin')" \`로 바꾸어보자



2. docker를 내리고 다시 올린다

3. `node query.js`시 오류가 난다

   init부분에서 admin들이 보증을 하지 않아서 트랜젝션이 채택이 안됨

   그래서 couchDB를 보면 아무 것도 없다

   ![17](https://user-images.githubusercontent.com/20276476/80434392-a6534080-8934-11ea-939c-a69b797eb002.png)



*****



###### 다음은 peer로 바꾸어보자

1. 아까와 같이 startFabric.sh의 정책부분을 peer로 다 고친다
2. docker 내렸다가 재실행
3. 바꾸고 admin등록, user등록을 한 후 `node query.js`하면 값이 잘 나온다



*****



###### 마지막으로 client로 바꾸어 보자

1. 아까와 같이 startFabric.sh의 정책부분을 client로 다 고친다

2. docker 내렸다가 재실행

3. 바꾸고 couchdb를 살펴보면 db가 없다

   ![18](https://user-images.githubusercontent.com/20276476/80435320-25497880-8937-11ea-847d-b52ef8c2eb9d.png)



보증은 Peer만 된다 -> 그럼 다른 애들은 왜 만들어 놓은걸까?

~~아직 미스테리~~



*****



* fabcar.js 체인코드

  ```javascript
  /*
  # Copyright IBM Corp. All Rights Reserved.
  #
  # SPDX-License-Identifier: Apache-2.0
  */
  
  'use strict';
  const shim = require('fabric-shim');
  const util = require('util');
  
  let Chaincode = class {
  
    // The Init method is called when the Smart Contract 'fabcar' is instantiated by the blockchain network
    // Best practice is to have any Ledger initialization in separate function -- see initLedger()
    async Init(stub) {
      console.info('=========== Instantiated fabcar chaincode ===========');
      return shim.success();
    }
  
    // 적절한 함수명에 따라 함수를 실행시켜줌(없으면 에러)
    // The Invoke method is called as a result of an application request to run the Smart Contract
    // 'fabcar'. The calling application program has also specified the particular smart contract
    // function to be called, with arguments
    async Invoke(stub) {
      let ret = stub.getFunctionAndParameters();
      console.info(ret);
  
      let method = this[ret.fcn];
      if (!method) {
        console.error('no function of name:' + ret.fcn + ' found');
        throw new Error('Received unknown function ' + ret.fcn + ' invocation');
      }
      try {
        let payload = await method(stub, ret.params);
        return shim.success(payload);
      } catch (err) {
        console.log(err);
        return shim.error(err);
      }
    }
  
    async queryCar(stub, args) {
      if (args.length != 1) {
        throw new Error('Incorrect number of arguments. Expecting CarNumber ex: CAR01');
      }
      let carNumber = args[0];
  
      let carAsBytes = await stub.getState(carNumber); //get the car from chaincode state
      if (!carAsBytes || carAsBytes.toString().length <= 0) {
        throw new Error(carNumber + ' does not exist: ');
      }
      console.log(carAsBytes.toString());
      return carAsBytes;
    }
  
      // 초기화 함수
    async initLedger(stub, args) {
      console.info('============= START : Initialize Ledger ===========');
      let cars = [];
      cars.push({
        make: 'Toyota',
        model: 'Prius',
        color: 'blue',
        owner: 'Tomoko'
      });
      cars.push({
        make: 'Ford',
        model: 'Mustang',
        color: 'red',
        owner: 'Brad'
      });
      cars.push({
        make: 'Hyundai',
        model: 'Tucson',
        color: 'green',
        owner: 'Jin Soo'
      });
      cars.push({
        make: 'Volkswagen',
        model: 'Passat',
        color: 'yellow',
        owner: 'Max'
      });
      cars.push({
        make: 'Tesla',
        model: 'S',
        color: 'black',
        owner: 'Adriana'
      });
      cars.push({
        make: 'Peugeot',
        model: '205',
        color: 'purple',
        owner: 'Michel'
      });
      cars.push({
        make: 'Chery',
        model: 'S22L',
        color: 'white',
        owner: 'Aarav'
      });
      cars.push({
        make: 'Fiat',
        model: 'Punto',
        color: 'violet',
        owner: 'Pari'
      });
      cars.push({
        make: 'Tata',
        model: 'Nano',
        color: 'indigo',
        owner: 'Valeria'
      });
      cars.push({
        make: 'Holden',
        model: 'Barina',
        color: 'brown',
        owner: 'Shotaro'
      });
  
      for (let i = 0; i < cars.length; i++) {
        cars[i].docType = 'car';
        await stub.putState('CAR' + i, Buffer.from(JSON.stringify(cars[i])));
        console.info('Added <--> ', cars[i]);
      }
      console.info('============= END : Initialize Ledger ===========');
    }
  
    async createCar(stub, args) {
      console.info('============= START : Create Car ===========');
      if (args.length != 5) {
        throw new Error('Incorrect number of arguments. Expecting 5');
      }
  
      var car = {
        docType: 'car',
        make: args[1],
        model: args[2],
        color: args[3],
        owner: args[4]
      };
  
      await stub.putState(args[0], Buffer.from(JSON.stringify(car)));
      console.info('============= END : Create Car ===========');
    }
  
    async queryAllCars(stub, args) {
  
      let startKey = 'CAR0';
      let endKey = 'CAR999';
  
      let iterator = await stub.getStateByRange(startKey, endKey);
  
      let allResults = [];
      while (true) {
        let res = await iterator.next();
  
        if (res.value && res.value.value.toString()) {
          let jsonRes = {};
          console.log(res.value.value.toString('utf8'));
  
          jsonRes.Key = res.value.key;
          try {
            jsonRes.Record = JSON.parse(res.value.value.toString('utf8'));
          } catch (err) {
            console.log(err);
            jsonRes.Record = res.value.value.toString('utf8');
          }
          allResults.push(jsonRes);
        }
        if (res.done) {
          console.log('end of data');
          await iterator.close();
          console.info(allResults);
          return Buffer.from(JSON.stringify(allResults));
        }
      }
    }
  
    async changeCarOwner(stub, args) {
      console.info('============= START : changeCarOwner ===========');
      if (args.length != 2) {
        throw new Error('Incorrect number of arguments. Expecting 2');
      }
  
      let carAsBytes = await stub.getState(args[0]);
      let car = JSON.parse(carAsBytes);
      car.owner = args[1];
  
      await stub.putState(args[0], Buffer.from(JSON.stringify(car)));
      console.info('============= END : changeCarOwner ===========');
    }
  };
  
  shim.start(new Chaincode());
  ```



* stub은 뭐하는거?

  ![unnamed](https://user-images.githubusercontent.com/20276476/80437039-8e32ef80-893b-11ea-96b9-6cd804a39a50.jpg)

  client - server 간 통신 -> 소켓 통신을 한다

  Protocol : client, server간 약속된 신호(규약)

  소켓 통신간은 데이터 스트림으로 전송한다(바이트 단위로 전송됨)

  stub, skeleton은 이러한 통신에 도움을 주는 code layer이다(일종의 library)

  remote layer는 더 밑에서 통신에 도움을 주는 code layer

  RMI 구조



*****



###### first network에다가 추가로 example02_node 체인코드를 올려보자

1. cli로 접속

   `docker exec -it cli bash`



2. org 환경변수 설정

   ```bash
   # Org1
   CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
   CORE_PEER_ADDRESS=peer0.org1.example.com:7051
   CORE_PEER_LOCALMSPID="Org1MSP"
   CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
   
   # Org2
   CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
   CORE_PEER_ADDRESS=peer0.org2.example.com:9051
   CORE_PEER_LOCALMSPID="Org2MSP"
   CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
   ```

   

3. chaincode_example02 체인코드 인스톨

   ```bash
   peer chaincode install -n send_money -v 1.0 -l node -p /opt/gopath/src/github.com/chaincode/chaincode_example02/node
   ```



4. install된 체인코드 instantiate

   ```bash
   peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n send_money -l node -v 1.0 -c '{"Args":["init","a", "100", "b","200"]}'  -P "OR ('Org1MSP.member','Org2MSP.member')" 
   ```

   

5. query.js를 복사하여 query_money.js로 이름을 바꾼 후 일부를 수정하여 실행

   ```javascript
   /*
    * SPDX-License-Identifier: Apache-2.0
    */
   
   'use strict';
   
   const { FileSystemWallet, Gateway } = require('fabric-network');
   const path = require('path');
   
   const ccpPath = path.resolve(__dirname, '..', '..', 'first-network', 'connection-org1.json');
   
   async function main() {
       try {
   
           // Create a new file system based wallet for managing identities.
           const walletPath = path.join(process.cwd(), 'wallet');
           const wallet = new FileSystemWallet(walletPath);
           console.log(`Wallet path: ${walletPath}`);
   
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               console.log('Run the registerUser.js application before retrying');
               return;
           }
   
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
           
   //////////////////////////////////////////////////////////////////////////
           // Get the contract from the network.
           const contract = network.getContract('send_money');
   //////////////////////////////////////////////////////////////////////////
           
           // Evaluate the specified transaction.
           // queryCar transaction - requires 1 argument, ex: ('queryCar', 'CAR4')
           // queryAllCars transaction - requires no arguments, ex: ('queryAllCars')
   //////////////////////////////////////////////////////////////////////////
           const result = await contract.evaluateTransaction('getBalance','a');
   //////////////////////////////////////////////////////////////////////////
           console.log(`Transaction has been evaluated, result is: ${result.toString()}`);
   
       } catch (error) {
           console.error(`Failed to evaluate transaction: ${error}`);
           process.exit(1);
       }
   }
   
   main();
   
   ```

   

6. invoke.js를 복사해 invoke_money.js로 이름 변경 후 일부를 수정한 후 실행

   ```javascript
   /*
    * SPDX-License-Identifier: Apache-2.0
    */
   
   'use strict';
   
   const { FileSystemWallet, Gateway } = require('fabric-network');
   const path = require('path');
   
   const ccpPath = path.resolve(__dirname, '..', '..', 'first-network', 'connection-org1.json');
   
   async function main() {
       try {
   
           // Create a new file system based wallet for managing identities.
           const walletPath = path.join(process.cwd(), 'wallet');
           const wallet = new FileSystemWallet(walletPath);
           console.log(`Wallet path: ${walletPath}`);
   
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               console.log('Run the registerUser.js application before retrying');
               return;
           }
   
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
           
   //////////////////////////////////////////////////////////////////////////
           // Get the contract from the network.
           const contract = network.getContract('send_money');
   //////////////////////////////////////////////////////////////////////////
           
           // Submit the specified transaction.
           // createCar transaction - requires 5 argument, ex: ('createCar', 'CAR12', 'Honda', 'Accord', 'Black', 'Tom')
           // changeCarOwner transaction - requires 2 args , ex: ('changeCarOwner', 'CAR10', 'Dave')
   //////////////////////////////////////////////////////////////////////////
           await contract.submitTransaction('send', 'a', 'b', '1');
   //////////////////////////////////////////////////////////////////////////
           console.log('Transaction has been submitted');
   
           // Disconnect from the gateway.
           await gateway.disconnect();
   
       } catch (error) {
           console.error(`Failed to submit transaction: ${error}`);
           process.exit(1);
       }
   }
   
   main();
   ```

   

   ![19](https://user-images.githubusercontent.com/20276476/80441849-bc69fc80-8946-11ea-9824-1b9d167f65bb.png)

   잘 실행되어 진다

   

7. hyperledger explorer로 모니터링이 가능하다

   1. 일단 깔아봅시다

      1. 새 터미널에서 `su ubuntu`

      2. `sudo apt install jq`

      3. `sudo apt install postgresql` -> mysql보다 경량인 db

      4. `git clone https://github.com/hyperledger/blockchain-explorer`

      5. `cd blockchain-explorer`

      6. ` git checkout -b v1.0.0-rc2`

      7. `cd app/persistence/fabric/postgreSQL/db`

      8. `./createdb.sh`

      9. `sudo -u postgres psql`

         ```text
         # fabricexplorer 데이터베이스 생성 확인
         \l  (명령 종료 시 \q)
         # fabricexplorer 로 진입
         \c fabricexplorer 
         # 테이블 생성 확인
         \d
         # 접속 종료
         \q
         ```

      10. first-network이 가동되어 있는지 확인

      11. root계정 터미널을 띄우고 

          `cd HLF/fabric-samples/first-network`

          `cp -rf crypto-config /home/ubuntu/`

      12. 다시 ubuntu계정 터미널에서 `tree ~/crypto-config`

      13. ubuntu계정 터미널을 새로 열고   

          `sudo gedit ~/blockchain-explorer/app/platform/fabric/connection-profile/first-network.json`

          Org1의 admin keystone을 카피해야 됨

          a16591c4fc5b66911a7bb696597e0cc891a061dcd938a665d15221a23ea6ef4f_sk

          ```json
          
          {
          	"name": "first-network",
          	"version": "1.0.0",
          	"license": "Apache-2.0",
          	"client": {
          		"tlsEnable": true,
          		"adminUser": "admin",
          		"adminPassword": "adminpw",
          		"enableAuthentication": false,
          		"organization": "Org1",
          		"connection": {
          			"timeout": {
          				"peer": {
          					"endorser": "300"
          				},
          				"orderer": "300"
          			}
          		}
          	},
          	"channels": {
          		"mychannel": {
          			"peers": {
          				"peer0.org1.example.com": {}
          			},
          			"connection": {
          				"timeout": {
          					"peer": {
          						"endorser": "6000",
          						"eventHub": "6000",
          						"eventReg": "6000"
          					}
          				}
          			}
          		}
          	},
          	"organizations": {
          		"Org1MSP": {
          			"mspid": "Org1MSP",
          			"fullpath": true,
          			"adminPrivateKey": {
          ///////////////////////////////////////////////////////////////////
          				"path": "/home/ubuntu/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore/3545e2bf4fad2e42f7f6001df410003d06eba11e756cbc63e655fddd766f1abf_sk"
          // 여기 있는 _sk 지우고 아까 복사한 keystone을 넣어줘야 함
          ///////////////////////////////////////////////////////////////////
          			},
          			"signedCert": {
          /////////////////////////////////////////////////////////////////// 
          				"path": "/home/ubuntu/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/signcerts/Admin@org1.example.com-cert.pem"
          ///////////////////////////////////////////////////////////////////
          			}
          		}
          	},
          	"peers": {
          		"peer0.org1.example.com": {
          			"tlsCACerts": {
          ///////////////////////////////////////////////////////////////////
          				"path": "/home/ubuntu/crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt"
          ///////////////////////////////////////////////////////////////////
          			},
          			"url": "grpcs://localhost:7051",
          			"eventUrl": "grpcs://localhost:7053",
          			"grpcOptions": {
          				"ssl-target-name-override": "peer0.org1.example.com"
          			}
          		}
          	}
          }
          ```

          

      14. 빌드

          ```bash
          cd ~/blockchain-explorer
          npm install
           
          cd ~/blockchain-explorer/client/
          npm install
          // npm test -- -u --coverage
          npm run build
           
          cd ~/blockchain-explorer/app/test
          npm install
          npm run test
          ```

          

      15. 실행

          ```bash
          ~/blockchain-explorer> sudo ./start.sh
          ```

          

      16. http://localhost:8080으로 들어가면 확인 할 수 있다

          admin/adminpw

   

*****



###### Web과 연결해 봅시다

1. `docker exec -it cli bash`



2. 피어마다 체인코드 install

   * peer1.org1

   ```bash
   CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
   CORE_PEER_ADDRESS=peer1.org1.example.com:8051
   CORE_PEER_LOCALMSPID="Org1MSP"
   CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls/ca.crt
   
   peer chaincode install -n send_money -v 1.0 -l node -p /opt/gopath/src/github.com/chaincode/chaincode_example02/node
   ```

   

   * peer0.org2

   ```bash
   ## peer0.org2
   CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
   CORE_PEER_ADDRESS=peer0.org2.example.com:9051
   CORE_PEER_LOCALMSPID="Org2MSP"
   CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
   
   peer chaincode install -n send_money -v 1.0 -l node -p /opt/gopath/src/github.com/chaincode/chaincode_example02/node
   ```

   

   * peer1.org2

   ```bash
   ## peer1.org2
   CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
   CORE_PEER_ADDRESS=peer1.org2.example.com:10051
   CORE_PEER_LOCALMSPID="Org2MSP"
   CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls/ca.crt
   
   peer chaincode install -n send_money -v 1.0 -l node -p /opt/gopath/src/github.com/chaincode/chaincode_example02/node
   ```

   

3. 다음과 같은 구조가 되도록 파일을 구성한다 (MYWEB 디렉토리)

   connection-org1.json 파일은 first-network에서 복사해 오고

   wallet 폴더는 fabcar/javascript 에서 복사해 와 wallet2라고 이름을 바꾼다

   ![20](https://user-images.githubusercontent.com/20276476/80450859-6ce2fb00-895d-11ea-9de4-50885be4d938.png)

   

4. routes/first_network_router.js를 생성해서 작성

   ```javascript
   const express = require('express');
   const router = express.Router();
   const fs = require('fs');
   const path = require('path');
    
   const FabricCAServices = require('fabric-ca-client');
   const { FileSystemWallet, X509WalletMixin, Gateway } = require('fabric-network');
    
   const ccpPath = path.resolve(__dirname, '..' , 'first_articles', 'connection-org1.json');
   const ccpJSON = fs.readFileSync(ccpPath, 'utf8');
   const ccp = JSON.parse(ccpJSON);
    
   // Create a new CA client for interacting with the CA.
   const caInfo = ccp.certificateAuthorities['ca.org1.example.com'];
   const caTLSCACerts = caInfo.tlsCACerts.pem;
   const ca = new FabricCAServices(caInfo.url, { trustedRoots: caTLSCACerts, verify: false }, caInfo.caName);
    
   // Create a new file system based wallet for managing identities.
   const walletPath = path.join(process.cwd(), 'wallet2');
   const wallet = new FileSystemWallet(walletPath);
   console.log(`Wallet path: ${walletPath}`);
   
   
   /* GET */
   router.get('/query', async (req, res, next) => {
       try{
       // Create a new file system based wallet for managing identities.
       const walletPath = path.join(process.cwd(), 'wallet2');
       const wallet = new FileSystemWallet(walletPath);
       console.log(`Wallet path: ${walletPath}`);
   
       // Check to see if we've already enrolled the user.
       const userExists = await wallet.exists('user1');
       if (!userExists) {
           console.log('An identity for the user "user1" does not exist in the wallet');
           console.log('Run the registerUser.js application before retrying');
           return;
       }
   
       // Create a new gateway for connecting to our peer node.
       const gateway = new Gateway();
       await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
       // Get the network (channel) our contract is deployed to.
       const network = await gateway.getNetwork('mychannel');
   
       // Get the contract from the network.
       const contract = network.getContract('send_money');
   
       // Evaluate the specified transaction.   
       const a_result = await contract.evaluateTransaction('getBalance','a');
       const b_result = await contract.evaluateTransaction('getBalance','b');
       
           console.log(`Transaction has been evaluated, result is: ${a_result.toString()} , ${b_result.toString()}`);
           res.json({'a_amount':a_result.toString(),'b_amount':b_result.toString()});
       }catch(e){
           console.log(e);
           res.json({'msg':'query error'});
       } 
   });
    
   /* POST */
   router.post('/send', async (req, res, next) => {
       try{
        // Create a new file system based wallet for managing identities.
        const walletPath = path.join(process.cwd(), 'wallet2');
        const wallet = new FileSystemWallet(walletPath);
        console.log(`Wallet path: ${walletPath}`);
   
        // Check to see if we've already enrolled the user.
        const userExists = await wallet.exists('user1');
        if (!userExists) {
            console.log('An identity for the user "user1" does not exist in the wallet');
            console.log('Run the registerUser.js application before retrying');
            return;
        }
   
        // Create a new gateway for connecting to our peer node.
        const gateway = new Gateway();
        await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
        // Get the network (channel) our contract is deployed to.
        const network = await gateway.getNetwork('mychannel');
   
        // Get the contract from the network.
        const contract = network.getContract('send_money');
   
        // Submit the specified transaction.     
        await contract.submitTransaction('send', 'a', 'b', '1');
        console.log('Transaction has been submitted');
   
        // Disconnect from the gateway.
        await gateway.disconnect();
   
       console.log(`Transaction has been submitted`);
       res.json({'msg':'ok'});
       }catch(e){
       console.log(e);
       res.json({'msg':'send error'});
       }
   });
   
   module.exports = router; 
   ```

   

5. server.js를 수정

   ```javascript
   const express=require("express");
   const path=require("path");
   const app=express(); 
    
   app.use(express.static(path.join(__dirname,"/public")));
    
   app.use(express.json());
   app.use('/basic_network', require('./routes/basic_network_router'));
   /////////////////////////////////////////////////////////////////////////
   app.use('/first_network', require('./routes/first_network_router'));
   /////////////////////////////////////////////////////////////////////////
   
   app.listen(3000,function(){
       console.log("3000 server ready...");
   });
   
   ```



6. index.jsx에 다음을 수정

   ```react
   const {Component}=React;
   const {Router,Route,IndexRoute,Link}=ReactRouter;
    
   class Main extends Component{
       render(){
           return(
               <div>
                   <h1>Hyperledger Fabric Study</h1>
                   <ul className="header">
                       <li><Link exact to="/">Home</Link></li>
                       <li><Link to="/basic">BasicNetwork</Link></li>
                       <li><Link to="/first">FirstNetwork</Link></li>
                   </ul>
                   
                   
                   <div>
                       {this.props.children}
                   </div>
               </div>
           );
       }
   }
    
   class Home extends Component{
       render(){
           return(
               <div>
                   <h2>Home</h2>
               </div>
           );
       }
   }
   class BasicNetwork extends Component{
       state={
           a_amount:0,
           b_amount:0
       }
    
       basic_network_connect=()=>{
           axios.get('basic_network/connect')
           .then((res)=>{
               console.log(res);
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       query=()=>{        
           axios.get('/basic_network/query')
           .then((response)=>{            
               this.setState({a_amount:response.data.a_amount, b_amount:response.data.b_amount});
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       send=()=>{
           alert(this.amount.value);
           axios.post('/basic_network/send',{"amount":this.amount.value})
           .then((response)=>{
               console.log(response);
               
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       render(){
          
           return(
               <div>
                   <h2>BasicNetwork
                   에 <button onClick={this.basic_network_connect}>연결</button></h2>
                   <br/>
                   <button onClick={this.query}  > 잔액 확인</button> {' '} 
                   a : <Amount bgColor='green' amount={this.state.a_amount}></Amount>
                   b : <Amount bgColor='red' amount={this.state.b_amount}></Amount>
                   <br/>               
                   <br/> 
                   <div>a가 b에게 {' '}
                   <input placeholder='송금량' ref={ref=>this.amount=ref} />원을 {' '} 
                   <button onClick={this.send}  > 보내기</button><br/>               
                   </div>
    
               </div>
           );
       }
   }
   class Amount extends Component{
       render(){
           var amountStyle={
               padding:10,
               margin:20,
               display:"inline-block",
               backgroundColor: this.props.bgColor,
               borderRadius: "50%" ,
               width : this.props.amount,
               height: this.props.amount,            
               textAlign: "center"            
           }
           return (
               <span style={amountStyle}>{this.props.amount}원</span>
           );
       }
   }
    
   //////////////////////////////////////////////////////////////////////////
   class FirstNetwork extends Component{
       state={
           a_amount:0,
           b_amount:0
       }
    
       first_network_connect=()=>{
           axios.get('first_network/connect')
           .then((res)=>{
               console.log(res);
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       query=()=>{        
           axios.get('/first_network/query')
           .then((response)=>{            
               this.setState({a_amount:response.data.a_amount, b_amount:response.data.b_amount});
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       send=()=>{
           alert(this.amount.value);
           axios.post('/first_network/send',{"amount":this.amount.value})
           .then((response)=>{
               console.log(response);
               
           })
           .catch((error)=>{
               console.log(error);
           });
       }
    
       render(){
          
           return(
               <div>
                   <h2>FirstNetwork
                   에 <button onClick={this.first_network_connect}>연결</button></h2>
                   <br/>
                   <button onClick={this.query}  > 잔액 확인</button> {' '} 
                   a : <Amount bgColor='magenta' amount={this.state.a_amount}></Amount>
                   b : <Amount bgColor='cyan' amount={this.state.b_amount}></Amount>
                   <br/>               
                   <br/> 
                   <div>a가 b에게 {' '}
                   <input placeholder='송금량' ref={ref=>this.amount=ref} />원을 {' '} 
                   <button onClick={this.send}  > 보내기</button><br/>               
                   </div>
    
               </div>
           );
       }
   }
   //////////////////////////////////////////////////////////////////////////
   
   ReactDOM.render(
       (<Router>
           <Route path="/" component={Main} >
               <IndexRoute component={Home} />
               <Route path="basic" component={BasicNetwork} />
               <Route path="first" component={FirstNetwork} />
           </Route>
       </Router>)
        , document.getElementById("root")
   );
   ```



7. `npm start`로 실행

   ![21](https://user-images.githubusercontent.com/20276476/80451317-7ae54b80-895e-11ea-8bf1-880f751a274d.png)



*****



###### fabcar도 web을 붙여보자

1. index.jsx를 다음과 같이 수정	

   ```react
   const {Component}=React;
   const {Router,Route,IndexRoute,Link}=ReactRouter;
    
   class Main extends Component{
       render(){
           return(
               <div>
                   <h1>Hyperledger Fabric Study</h1>
                   <ul className="header">
                       <li><Link exact to="/">Home</Link></li>
                       <li><Link to="/basic">BasicNetwork</Link></li>
                       <li><Link to="/first">FirstNetwork</Link></li>
   ////////////////////////////////////////////////////////////////////
                       <li><Link to="/fabcar">Fabcar</Link></li>
   ////////////////////////////////////////////////////////////////////
                   </ul>
                   
                   …
   
   ////////////////////////////////////////////////////////////////////
   class Fabcar extends Component{
       render(){
           return (
               <div>
                   <a href='fabcar.html' > 중고차 시장 가기 </a>
               </div>
           );
   
       }
   }
   ////////////////////////////////////////////////////////////////////
    
   ReactDOM.render(
       (<Router>
           <Route path="/" component={Main} >
               <IndexRoute component={Home} />
               <Route path="basic" component={BasicNetwork} />
               <Route path="first" component={FirstNetwork} />
   ////////////////////////////////////////////////////////////////////
               <Route path="fabcar" component={Fabcar} />
   ////////////////////////////////////////////////////////////////////
           </Route>
       </Router>)
        , document.getElementById("root")
   );
   
   ```

   

2. public/fabcar.html을 만들어 다음과 같이 작성

   ```html
   <!-- SPDX-License-Identifier: Apache-2.0 -->
   
   <!DOCTYPE html>
   <html>
     <head>
       <title>Hyperledger Fabric Tuna Application</title>
       <link rel="icon" href="favicon.png" type="image/gif">
   
       <!-- require jquery and bootstrap scripts -->
       <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
       <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
       <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
       
       
       <!-- adding style here -->
       <style type="text/css">
         header{
           background-color: lightgray;
           font-size:20px;
           padding:15px;
         }
         header, .form-group{
           margin-bottom: 3%;
         }
         .form-group{
           width:50%;
         }
         #body{
           margin-left:3%;
           margin-right:3%;
         }
         .form-control{
           margin: 8px;
         }
         #right_header{
           width:20%;
           font-size:15px;
           margin-right:0px;
         }
         #left_header{
           margin-left:0;
           width:40%;
           display:inline-block;
         } 
         #id {
           width:49%;
           display: inline-block;
         }
         table {
             font-family: arial, sans-serif;
             border-collapse: collapse;
             width: 100%;
         }
         td, th {
             border: 1px solid #dddddd;
             text-align: left;
             padding: 8px;
         }
         tr:nth-child(even) {
             background-color: #dddddd;
         }
       </style>
     </head>
     <body ng-app="application" ng-controller="appController">
       <header>
         <div id="left_header">Hyperledger Fabric FabCar Application</div>
         <i id="right_header">Example Blockchain Application for Introduction to Hyperledger Fabric</i>
       </header>
   
       <div id="body">
         <div class="form-group">
           <label>Query All Cars</label>
           <!--
             <p><input id="queryAllCar" type="submit" value="Query" class="btn btn-primary" ng-click="queryAllCar()"></p>
           -->
           <p><input id="queryAllCar" type="submit" value="QueryAllCars" class="btn btn-primary" ng-click="queryAllCar()"></p>
         </div>
         
         <div id="all_car"></div>
       <!--   <table id="all_car" class="table" align="center">
   
           <tr>
             <th>ID</th>
             <th>Color</th>
             <th>Make</th>
             <th>Model</th>
             <th>Owner</th>
           </tr>
   
           <tr ng-repeat="car in all_car">
             <td>{{car.Key}}</td>
             <td>{{car.colour}}</td>
             <td>{{car.make}}</td>
             <td>{{car.model}}</td>
             <td>{{car.owner}}</td>
           </tr>
         </table> -->
   
         <div class="form-group">
           <label>Query a Specific Car</label><br>
           <h5 style="color:red;margin-bottom:2%" id="error_query">Error: Please enter a valid Car Id</h5>
           
           Enter a Car number: 
           <!--<input id="createName" class="form-control" type="text" placeholder="CAR0" ng-model="car_id">
           <input id="querySubmit" type="submit" value="Query" class="btn btn-primary" ng-click="queryCar()">-->
           <input id="queryName" class="form-control" type="text" value="CAR0" ng-model="car_id">
           <input id="querySubmit" type="submit" value="Query" class="btn btn-primary" >
         </div>
   
         <div id="query_car_content">
           <table  class="table" align="center">
   
             <tr>
               <th>Color</th>
               <th>Make</th>
               <th>Model</th>
               <th>Owner</th>
             </tr>
     
             <tr id="query_car">           
               <td>{{car.colour}}</td>
               <td>{{car.make}}</td>
               <td>{{car.model}}</td>
               <td>{{car.owner}}</td>
             </tr>
           </table>
         </div>
   
         <div class="form-group">
           <label>Create New Car</label>
           <h5 style="color:green;margin-bottom:2%" id="success_create">
             </h5>
           <br>
           Enter Car Number: <input class="form-control" type="text" value="CAR10" id="car_id">
           Enter name of Owner: <input class="form-control" type="text" value="EunSuJEON" id="car_owner">
           Enter Make: <input class="form-control" type="text" value="KIA" id="car_make"> 
           Enter Model: <input class="form-control" type="text" value="Sorrento" id="car_model">
           Enter Color: <input class="form-control" type="text" value="red" id="car_colour">
          <!--  <input id="createSubmit" type="submit" value="Create" class="btn btn-primary" ng-click="recordCar()">  -->
           <input id="createSubmit" type="submit" value="Create" class="btn btn-primary" > 
         </div>
   
         <div class="form-group">
           <label>Change Car Owner</label><br>
           <h5 style="color:green;margin-bottom:2%" id="success_holder"></h5>
           <!-- <h5 style="color:red;margin-bottom:2%" id="error_holder">Error: Please enter a valid Car Id</h5> -->
           Enter a Car Number : <input class="form-control" id="car_id2" value="CAR10" >
           Enter name of new Owner: <input class="form-control" id="car_owner2" value="EunSu JEON" >
           <input id="transferSubmit" type="submit" value="Change" class="btn btn-primary" >
         </div>
   
       </div>
     </body>
       <!-- requiring the angular page 
       <script type="text/javascript" src="app.js"> </script>-->
       <script type="text/javascript" src="my.js"> </script>
   </html>
   ```



3. public/my.js를 만들어 다음과 같이 작성

   ```javascript
   $(document).ready(function () {
   	$("#error_query").hide();
   	$("#success_create").hide();
   	$("#success_holder").hide();
   
   	$("#transferSubmit").click( function(){
   		var owner = {'car_id': $("#car_id2").val() ,'car_owner': $("#car_owner2").val() };
   		if(confirm(JSON.stringify( owner )+'\n 소유주 변경 정보가 맞습니까?')){
       	
               $.post({
                   traditional: true,
                   url: '/fabcar_network/change_owner/',
                   contentType: 'application/json',
                   data: JSON.stringify( owner ),
                   dataType: 'json',
                   success: function(data){                 
                       alert(data.msg);
                       if(data.code=='1'){
                           $("#success_holder").show().html(`Success! Tx ID: ${data.msg}`);
                       }else{
                           $("#success_holder").show().html(`Fail! please retry: ${data.msg}`).css('color','red');
                       }
                   }
               } );
           }
   	});
   
   
   	$("#createSubmit").click( function(){
           var car = {'car_id':$("#car_id").val(),
                       'car_colour': $("#car_colour").val(),
                       'car_make' : $("#car_make").val() ,
                       'car_model': $("#car_model").val() ,
                       'car_owner' : $("#car_owner").val()};
   		if(confirm('[입력 차량 정보]\n'+JSON.stringify( car )+'\n가 맞습니까?')){
       	
               $.post({
                   traditional: true,
                   url: '/fabcar_network/add_car/',
                   contentType: 'application/json',
                   data: JSON.stringify( car ),
                   dataType: 'json',
                   success: function(data){                 
                       alert(data.msg);
                       if(data.code=='1'){
                           $("#success_create").show().html(`Success! Tx ID: ${data.msg}`);
                       }else{
                           $("#success_create").show().html(`Fail! please retry: ${data.msg}`).css('color','red');
                       }
                   }
               } );	
           }
   	});
   
   	$("#querySubmit").click( function(){
   
           var id = $("#queryName").val();  
           alert( id +' 정보를 조회합니다');      
   
           $.post({
               traditional: true,
               url: '/fabcar_network/get_car/',
               contentType: 'application/json',
               data: JSON.stringify( {'queryName' : id} ),
               dataType: 'json',
               success: function(data){ 
                   console.log( data );                                  
                   let content;
                   try{
                       let _data=JSON.parse(data.queryCar); 
                       content=`<td>${_data.colour}</td>`
                                     +`<td>${_data.make}</td>`
                                     +`<td>${_data.model}</td>`
                                     +`<td>${_data.owner}</td>`;
                       
                       $("#error_query").hide();
                   }catch(e){
                       alert(id+ " 정보는 존재하지 않습니다");
                       content='<td>undefined</td><td>undefined</td><td>undefined</td><td>undefined</td>';
                       $("#error_query").show();
                   }               
                                   
                   $("#query_car").html(content);
               }
           } );		
   	});
   	
       $('#queryAllCar').click(function () {        
           alert('모든 차 정보를 조회합니다');
           
           $.get("/fabcar_network/get_all_car/",function (data,status) {
               var result=JSON.parse(data.queryAllCars);
               console.log(result.length);
   			var array = [];
   			for (var i = 0; i <result.length; i++){
   				result[i].Record.Key = result[i].Key;
   				array.push(result[i].Record);
   			}
   			array.sort(function(a, b) {
   			    return parseFloat(a.Key) - parseFloat(b.Key);
   			});
   			
   
   			var content='<table id="all_car" class="table" align="center">'
   			+'<tr><th>ID</th><th>Color</th><th>Make</th><th>Model</th><th>Owner</th></tr>';
   			array.forEach((car)=>{
   				content += `<tr><td>${car.Key}</td><td>${car.colour}</td><td>${car.make}</td> <td>${car.model}</td> <td>${car.owner}</td></tr>`;
   			});
           
   			content += '</table>';
   			//alert(content);
   			$('#all_car').html(content);
   			
           });
       });
   });
   ```

   

4. server.js에 다음을 추가

   ```javascript
   
   
   const express=require("express");
   const path=require("path");
   const app=express(); 
    
   app.use(express.static(path.join(__dirname,"/public")));
    
   app.use(express.json());
   
   /* app.use(function (req, res, next) {
       console.log('server:', req.originalUrl);
       console.log('body:', req.body);
       next();
     }); */
   
   const basic_network_router=require('./routes/basic_network_router');
   app.use('/basic_network', basic_network_router);
   const first_network_router=require('./routes/first_network_router');
   app.use('/first_network', first_network_router);
   ///////////////////////////////////////////////////////////////////////
   const fabcar_router=require('./routes/fabcar_router');
   app.use('/fabcar_network', fabcar_router);
   ///////////////////////////////////////////////////////////////////////
    
   app.listen(3000,function(){
       console.log("3000 server ready...");
   });
   
   ```

   

5. routes/fabcar_router.js를 만들어 다음과 같이 작성

   ```javascript
   
   
   const express = require('express');
   const router = express.Router();
   const fs = require('fs');
   const path = require('path');
    
   const FabricCAServices = require('fabric-ca-client');
   const { FileSystemWallet, X509WalletMixin, Gateway } = require('fabric-network');
    
   const ccpPath = path.resolve(__dirname, '..' , 'first_articles', 'connection-org1.json');
   const ccpJSON = fs.readFileSync(ccpPath, 'utf8');
   const ccp = JSON.parse(ccpJSON);
    
   // Create a new CA client for interacting with the CA.
   const caInfo = ccp.certificateAuthorities['ca.org1.example.com'];
   const caTLSCACerts = caInfo.tlsCACerts.pem;
   const ca = new FabricCAServices(caInfo.url, { trustedRoots: caTLSCACerts, verify: false }, caInfo.caName);
    
   // Create a new file system based wallet for managing identities.
   const walletPath = path.join(process.cwd(), 'wallet2');
   const wallet = new FileSystemWallet(walletPath);
   console.log(`Wallet path: ${walletPath}`);
   
   
   /* GET */
   router.get('/get_all_car', async (req, res, next) => {
       try{
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               console.log('Run the registerUser.js application before retrying');
               return;
           }
   
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
   
           // Get the contract from the network.
           const contract = network.getContract('fabcar');
   
           // Evaluate the specified transaction.   
           const result = await contract.evaluateTransaction('queryAllCars');
           console.log(`Transaction has been evaluated, result is: ${result.toString()} `);
           res.json({'queryAllCars':result.toString()});
       }catch(e){
           console.log(e);
           res.json({'msg':'query error'});
       }
   });
    
   /* post */
   router.post('/get_car', async (req, res, next) => {
       try{
         
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               console.log('Run the registerUser.js application before retrying');
               return;
           }
   
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
   
           // Get the contract from the network.
           const contract = network.getContract('fabcar');
   
           // Evaluate the specified transaction.   
           const result = await contract.evaluateTransaction('queryCar', `${req.body.queryName}`);
           console.log(`Transaction has been evaluated, result is: ${result.toString()} `);
           res.json({'queryCar':result.toString()});
       }catch(e){
           console.log(e);
           res.json({'msg':'query error'});
       }    
   });
   
   /* post */
   router.post('/add_car', async (req, res, next) => {
       try{
           
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               console.log('Run the registerUser.js application before retrying');
               return;
           }
   
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
   
           // Get the contract from the network.
           const contract = network.getContract('fabcar');
   
           // Evaluate the specified transaction.   
           await contract.submitTransaction('createCar', `${req.body.car_id}`, `${req.body.car_make}`, `${req.body.car_model}`, `${req.body.car_colour}`, `${req.body.car_owner}`);
           console.log(`Transaction has been evaluated, result is ok`);
           res.json({'code':'1','msg':`${req.body.car_id}가 정상적으로 입력되었습니다`});
       }catch(e){
           console.log(e);
           res.json({'code':'0','msg':`${req.body.car_id} 입력 오류`});
       }    
   });
   
   /* post */
   router.post('/change_owner', async (req, res, next) => {
       try{
           
           // Check to see if we've already enrolled the user.
           const userExists = await wallet.exists('user1');
           if (!userExists) {
               console.log('An identity for the user "user1" does not exist in the wallet');
               console.log('Run the registerUser.js application before retrying');
               return;
           }
   
           // Create a new gateway for connecting to our peer node.
           const gateway = new Gateway();
           await gateway.connect(ccpPath, { wallet, identity: 'user1', discovery: { enabled: true, asLocalhost: true } });
   
           // Get the network (channel) our contract is deployed to.
           const network = await gateway.getNetwork('mychannel');
   
           // Get the contract from the network.
           const contract = network.getContract('fabcar');
   
           // Evaluate the specified transaction
           await contract.submitTransaction('changeCarOwner', `${req.body.car_id}`,  `${req.body.car_owner}`);
           console.log(`Transaction has been evaluated, result is ok`);
           res.json({'code':'1','msg':`${req.body.car_id}가 정상적으로 변경되었습니다`});
       }catch(e){
           console.log(e);
           res.json({'code':'0','msg':`${req.body.car_id} 변경 오류`});
       }    
   });
   
   module.exports = router;
   ```



6. 결과화면

   ![22](https://user-images.githubusercontent.com/20276476/80562284-4044e700-8a22-11ea-902a-29ce7f5bca59.png)

   위의 QueryAllCars를 누르면 전체 차 정보가 조회된다

   

   ![23](https://user-images.githubusercontent.com/20276476/80562356-75513980-8a22-11ea-8950-d718b16c8423.png)

   특정 ID로 차를 조회하면 차가 조회된다

   

   ![24](https://user-images.githubusercontent.com/20276476/80562422-afbad680-8a22-11ea-95e0-5f6b2863d096.png)

   차량 입력

   

*****



###### 번외 : 차량의 소유주들의 기록을 조회해보자

